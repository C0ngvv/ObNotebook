

Firmadyne基于软件实现全系统仿真实现对固件的自动化动态分析。

Firmadyne主要由四部分组成，固件获取、固件提取、固件模拟、动态分析。

## 固件模拟失败的原因

### 1.引导出错

#### 1.初始化程序没有正确执行

初始化通常由init程序执行，内核通过检查预定义的路径(例如/sbin/init、/etc/init和/bin/init)来查找该程序。一些固件的初始化程序是自定义的路径，内核找不到初始化程序无法执行而崩溃。如在NETGEAR和一些TP-Link中使用的名字是preinit。

Firmadyne做法是构建一个硬编码的常被访问的初始化程序文件列表。但这些文件列表不足以涵盖所有的初始化程序路径。

FirmAE的方法是提取内核中用于引导过程默认配置的命令行字符串，如下面提取出的字符串可以识别出初始化程序路径为/etc/preinit。通过使用从原始内核获得的信息配置环境，可以正确地初始化客户机系统而不会失败。若无法提取到信息，则从文件系统中寻找初始化程序，如preinit或preinitMT。

```
console=ttyS0,115200 root=31:08 rootfstype=squashfs init=/etc/preinit
```

#### 2.缺失文件系统结构

其他失败情况是由于缺少文件或目录而发生的，当内部程序试图访问这些路径时就会崩溃。

Firmadyne的做法是在自定义的引导脚本开头创建并挂载硬编码路径。该方法对一些硬编码的路径确实有效，例如，设置/etc/TZ或/etc/hosts可以帮助解决一些此类问题。然而，这种方法不能解释不同的情况。此外，由于它在固件初始化自己之前强制创建文件和目录，它会与在同一路径上创建和挂载其他文件或目录的内部程序发生冲突。

FirmAE的方法是从文件系统中的可执行二进制文件中提取所有字符串，然后对它们进行筛选，从而获得极有可能指示路径的字符串，并根据这些路径准备文件结构。特别地，选择了以一般Unix路径开头的字符串，例如/var或/etc。

### 2.NVRAM

NVRAM用于存储配置数据，若不支持NVRAM，程序就会崩溃。

Firmadyne实现了一个定制的NVRAM库来模拟NVRAM相关的函数，通过设置LD_PRELOAD环境变量实现预加载，拦截与NVRAM相关的函数，如nvram_get()和nvram_set()。当调用nvram_set()时，键值对存储在一个文件中，稍后在调用nvram_get()时提取它。若在调用nvram_set()之前调用nvram_get()，则使用固件中的默认文件初始化键-值对，这些默认文件通常用于设备的恢复出厂设置功能。Firmadyne有一个默认文件的硬编码路径列表，用于提取键-值对。

#### 1.未支持自定义的NVRAM默认文件

（1）默认文件位置不在硬编码路径列表内。

（2）默认文件格式不支持。这些文件中键值对使用不同的分割符，如回车或NULL字节，有些文件为特定于供应商的格式，如OBJ或ELM。

FirmAE解决：预模拟期间记录nvram_get()和nvram_set()函数访问的所有键值对，然后扫描目标固件的文件系统，搜索包含记录的键名的文件，提取键值并利用它们。

#### 2.没有NVRAM默认文件

有的固件映像没有默认的NVRAM文件。Firmadyne对这种情况直接返回NULL，很多程序未经检查就使用该返回值，如strcpy()，从而在NULL指针解引用时崩溃。

FirmAE做法返回一个指向空字符串的指针而非NULL值。

### 3.网络配置问题

#### 1.IP别名处理

为一个网络接口分配多个IP地址被称为IP别名。它在路由器中很流行，因为它可以通过IP地址单独管理服务。

Firmadyne在预模拟步骤中，IP别名由内核记录，然后，Firmadyne解析日志并试图分配所有的记录的IP地址给对应的客户机接口。然后，它为这些IP地址添加静态路由规则，将它们链接到主机中的TAP接口。在这种情况下，在一个TAP接口上添加多条路由规则，会造成网络冲突。

FirmAE通过让主机系统使用它的默认路由规则来进行仲裁。即使使用了IP别名，一旦客户机的网络接口连接到主机的TAP接口，所有数据包都会自动在主机和客户机之间路由。

#### 2.没有网络信息

 一些固件映像在其内核日志中不包含任何关于可连接网络接口(如eth)的信息。这些映像只配置环回接口(lo)，不设置其他网络接口。由于缺乏可连接的网络接口，主机系统无法访问这些映像。此外，一些映像试图将其web服务器绑定到一个不存在的网络接口上，从而导致崩溃。

FirmAE通过强制使用默认设置配置网络来解决，设置一个以太网接口eth0，其IP地址为192.168.0.1。在以太网接口建立之后，它将与默认桥接接口br0链接（对于内核日志中包含桥接接口信息的映像）。

#### 3.ARM中多个网络接口

 要支持多个网络接口，必须选择一个适当的加载目标固件的机器。遵从先前研究中所采用的方法，选择virt，这是QEMU支持的一种机器。这对一些固件镜像来说表现很好，然而，它不能模拟具有多个网络接口的ARM固件映像。

Firmadyne试图通过准备固定数量(四个)的虚拟接口来解决这个多接口问题。它的基本假设是，接口的数量应该大于或等于从内核日志中提取出的接口名称的后缀，例如，如果记录了eth1，则很可能eth0也存在。然而，几乎所有的ARM图像仍然没有被模拟成功。

FirmAE通过强制只设置一个以太网接口的高级干预来解决这个故障。具体地说，强制设置一个以太网接口eth0，并避免设置其他接口。设置了一个网桥接口，在必要时将其连接到主机。

#### 4.VLAN设置不足

VLAN接口与其他网络接口(如以太网或WLAN)具有不同的特性，因此必须为其设置额外的选项。为了支持VLAN，需要将TAP接口的类型设置为VLAN，并为其分配合适的VLAN id。一些故障发生在带有VLAN接口的固件映像中。在模拟这些映像时，即使以太网接口正确地配置了独立的IP地址，客户网络仍然不可访问。

Firmadyne试图通过在设置主机TAP接口时运行命令来解决这个问题，但他们的配置不足以解决这个问题。特别是，VLAN应该被配置来对使用相同的VLAN id对主机和客户网络进行分组。然而，Firmadyne没有设置主机网络。

FirmAE通过正确配置VLAN进行仲裁。

#### 5.iptables过滤问题

许多路由器都设置了防火墙，以防止未经授权的远程访问，否则，攻击者就可以访问管理接口。一些固件通过iptables，丢弃了所有来自主机的数据包，大多数这种情况发生在TP-Link中。

FirmAE的做法是删除客户系统中的过滤规则，这可以简单地通过刷新iptables中的所有策略并设置默认策略来接受所有传入的数据包来实现。

### 4.内核问题

#### 1.内核模块支持不足



#### 2.不适当的内核版本

Firmadyne在固件仿真中定制了Linux内核v2.6.32，然而最近的嵌入式设备使用更新版本的内核。

对于这个问题，升级内核版本似乎是一个很容易的解决方案。实际上，我们对Linux内核v4.1.17进行了实验测试，并成功模拟了更多固件映像。然而一些固件映像，特别是较旧的映像，不能用新版本的内核模拟，它们因为libc库崩溃而模拟失败。
