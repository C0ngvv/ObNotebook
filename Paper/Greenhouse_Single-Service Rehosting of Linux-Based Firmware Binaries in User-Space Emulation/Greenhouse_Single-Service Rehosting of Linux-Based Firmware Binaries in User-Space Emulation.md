2023 Usenix

# 翻译
## 摘要
随着物联网设备的日益普及，扩展当前的分析技术以匹配成为一项越来越重要的任务。这一挑战的一部分不仅涉及在模拟环境中重新托管这些嵌入式设备的固件，而且还涉及在这样做时发现真正的漏洞。当前最先进的重托管方法必须考虑到仿真设备和物理设备之间的差异，因此通常侧重于提高仿真保真度。然而，这种对保真度的追求忽略了其他潜在的解决方案。

在本文中，我们提出了一种新颖的重托管技术，用户空间单服务重托管，它模拟了用户空间中的单个固件服务。我们研究了数百个固件样本中涉及的重托管过程，以概括一组防止模拟的障碍，并创建干预措施来解决这些障碍。我们的原型Greenhouse自动重新托管了来自9个不同供应商的7,140个固件映像中的2,841个(39.7%)。我们的方法避开了以前重新托管技术遇到的许多挑战，并使我们能够将常见的漏洞发现技术应用于我们的重新托管图像，例如用户空间覆盖引导的模糊测试。使用这些技术，我们在重新托管的固件服务的一个子集上发现了717个n日漏洞和26个零日漏洞。

## 1.引言
物联网(IoT)的数量几乎是人类的2倍:截至2022年，大约有144亿个连接的物联网设备[18]存在于野外，目前估计到2025年总数将达到342亿个[21]。当然，这些设备的安全性并不完美，仅在2022年上半年，就有86家不同供应商的747个漏洞被披露[34]。物联网固件中未被发现、未报告和潜伏的漏洞的实际数量几乎肯定要高得多。

为了发现物联网设备中的潜在漏洞，研究人员希望在物联网设备固件上应用程序分析技术，包括web扫描和覆盖引导模糊测试等动态方法。然而，这种尝试往往因物联网设备的不可访问性而受到限制:购买它们无法扩展，并且可能耗时，过于昂贵，甚至不可能。即使可以物理访问物联网设备，这些设备上的硬件、操作系统和应用程序的刚性通常也会使上述动态分析技术的应用变得非常困难。

解决此问题的常见解决方案是固件重新托管，或简称重新托管，它在强大、灵活的非物联网设备(如个人计算机(pc)和服务器)上模拟物联网软件。重新托管的一个关键挑战是对每个物联网设备特定的特征和功能的高保真仿真。例如，物联网固件通常将数据存储在NVRAM(非易失性随机存取存储器)中，这在大多数x86 pc上不存在，必须由重新托管环境模拟。外围设备也可能带来困难。无线路由器上的软件服务可以使用仅存在于路由器上的天线发送和接收无线电信号，并且天线行为的完全模拟通常需要大量的手工工作。

为了寻求高重寄存保真度，研究人员提出了一些技术，要么模拟外围设备[4,14,19,22,28]，要么代理与运行在真实物联网设备上的外围设备的通信[17,27,33]。然而，大多数当前的外设感知重托管技术只允许基于小型嵌入式软件平台(如FreeRTOS[2]或Arduino[3])的固件分析，或者根本没有操作系统(“裸机”blobs)。关键是，目前的方法无法扩展到分析更复杂的基于linux的固件，而43%的物联网设备使用linux操作系统[15]。

针对基于Linux的固件的最先进的重新托管解决方案依赖于外设无关的全系统重新托管，通常通过将固件示例重新打包为标准文件系统格式，用重托管主机特定的版本替换嵌入式Linux内核以支持一些特殊的通用设备仿真，并在全系统模拟器(如QEMU)中启动固件示例[5,21]。然而，这种对重新托管保真度的隐式让步(例如，通过替换嵌入式内核)会导致重新托管失败。例如,Firmadyne[5]仅在21%的尝试固件样本上实现IP连接。即使对于表面上正确重托管的固件，保真度的缺乏也会导致固件操作错误:FirmAE [21]， Firmadyne的改进版本，测量了79%的成功重托管率，但我们在本文中表明，几乎一半的FirmAE重托管目标实际上没有保持足够的功能来测试面向外部的服务。

缓解重托管失败的一个明确的研究方向是提高保真度。但是，这种对模拟保真度的追求是重新托管的必要条件吗？我们对过去两年中关于NVD[25]的100个固件cve进行了随机抽样，发现其中只有14%与硬件相关，其余许多本质上独立于难以模拟的特定于设备的特性和功能。例如，在2022年9月，Tenda在其基于linux的AC21设备固件的httpd二进制面向网络的功能中披露了10个缓冲区溢出漏洞(CVE-2022-40067至CVE-2022-40076)，这些漏洞都不需要与外围设备交互。为了在物联网软件上进行漏洞发现和漏洞验证，如果不需要这些特征和特征就可以运行的脆弱服务，通常不需要对这些特征和特征进行高保真仿真。事实上，对保真度的追求可能会使研究人员忽视其他潜在的技术，这些技术可能能够成功地实现特定目的的重新托管。

在本文中，我们提出了一种新的重托管技术:自动化单服务重托管。与其他重新托管解决方案不同，单服务重新托管不要求对操作系统或硬件进行高保真仿真。相反，我们设计了一系列技术，在重新托管固件服务期间自动发现执行障碍，使用干预工具包(例如，修补服务二进制文件以消除某些环境检查)来克服这些障碍，并验证打补丁的服务以检查我们的补丁是否破坏了预期的功能。由于不模拟特定于操作系统或硬件的特征和特性，我们的解决方案不仅避免了全系统技术遇到的陷阱(例如插入的重托管内核与嵌入式系统本身之间的不兼容性)，而且还支持用户空间仿真，这大大降低了全系统仿真技术所显示的执行开销。此外，用户空间模拟支持常见的漏洞发现和验证技术，例如覆盖引导的模糊测试。

我们开发了一个平台Greenhouse，通过用户空间模拟来执行单个服务的自动重新托管。我们的方法完全重新托管了7,140个抓取的固件映像中的2,841个web服务器，并使用routersplit框架成功确认了717个n天漏洞[36]。我们还将重新托管的镜像与afl++[39]集成在一起，在用户空间中进行模糊测试，实现了比最先进的固件模糊测试解决方案EQUAFL[41]高200%的吞吐量。然后，我们将此集成扩展到数据集中的2,612个目标，并发现了11,395个独特的崩溃。在这些目标中，我们进一步检查了14个重新托管的目标，其中有79个崩溃，并确认了26个为零日漏洞。

最后，在为Greenhouse开发服务验证检查的过程中，我们发现之前的工作错误地将无功能的重新托管固件服务报告为成功的重新托管目标。例如，FirmAE对重新托管的web服务器执行HTTP请求以确定重新托管成功，但不检查网页的内容或错误状态码(即，只检查服务是否响应某些内容)。这些无功能性服务在发现或评估漏洞方面用处有限。因此，我们还提出了区分重新托管失败、部分重新托管服务和完全重新托管服务的新标准。使用这种技术，我们的比较评估表明，Greenhouse在固件重新托管方面比最先进的工作稍微成功一些，但重新托管的大多是不同的固件，当与全系统重新托管方法结合使用时，产生3,981个独特的重新托管样本。

总之，我们的贡献是:
- 我们提出了一种新的重新托管技术，用户空间单服务重新托管，用于重新托管固件服务，以查找和评估物联网软件上的漏洞。我们在一个名为Greenhouse的原型中实现了这项技术。
- 我们彻底研究了重新托管过程，并提供了用户模式重新托管中模拟失败的原因(称为障碍)的详细分解，以及通用和特定的干预措施。
- 我们对来自9个不同供应商的7140个独特固件样本进行了大规模评估，并完全重新托管了2841个web服务器。我们还通过与最先进的固件模糊测试解决方案EQUAFL进行比较，展示了Greenhouse在漏洞发现和评估方面的独特优势。

本着开放科学的精神，我们在https://github:com/sefcom/Greenhouse公开发布温室和研究成果的来源。

## 2.背景和动机
重新托管是在模拟环境中重新创建一个或多个固件服务的行为的过程。鉴于物联网世界安全的严峻形势，大多数固件重托管技术旨在使安全分析技术，如自动漏洞发现[14,22,27,32,40]和漏洞风险评估(即评估漏洞对固件的实际影响)[5,21,42]能够在固件目标上执行。

在本节中，我们首先讨论现有作品的不同重新托管目标(第2.1节)。接下来，我们定义重新托管保真度(第2.2节)，将现有工作的目标和重点映射到不同的保真度水平，并确定研究差距(第2.3节)。最后，我们提出了填补空白的解决方案(第2.4节)。

### 2.1 重托管目标
固件及其原始硬件的刚性严重限制了研究人员可以进行的分析类型。因此，将自动化和可扩展的安全分析应用于固件服务的需求激发了固件重托管研究[13]。由于这些固件服务通常与其软件和硬件环境紧密耦合，因此即使模拟单个服务也可能需要重新创建所有底层硬件和软件组件。由于物联网固件的不同性质，为每个固件服务创建一个完美的仿真是复杂的。

研究人员将物联网固件分为三种类型[13,24]:Type-I固件，运行适应嵌入式环境的通用操作系统(如Linux)。Type-II型固件，它具有为嵌入式环境设计的定制操作系统，但仍然在应用层和内核之间具有区别。Type-III 型固件，也称为“单片固件”，其中代码是在设备上运行的单个blob，并使用专用接口与硬件进行交互。由于Type-II型和Type-III型固件与其硬件紧密耦合，与Type-I型重托管工具相比，Type-II型和Type-III型的通用重托管工具不太常见。

重新托管技术必须提供一个能够执行固件服务的虚拟环境，并根据其分析最小化重新托管环境与原始环境(即真实设备)之间的差异。例如，希望分析外围通信协议(例如USB)安全性的工作必须模拟或集成这些组件[19,27,33]。最小化环境差异的解决方案可以模拟中间硬件层[7,14]。

### 2.2 重托管保真度
模拟环境和原始环境之间的差异可能导致重新托管的服务表现不同，甚至无法运行。抽象地说，我们将仿真固件组件的保真度定义为它与真实设备上的相同组件相似的程度。我们进一步将静态组件(如文件)的保真度称为提取保真度，将动态组件(如服务的运行时行为)的保真度称为执行保真度。一般来说，组件与原始设备上的对应组件越相似，仿真的保真度就越高。

**提取的保真度**。固件映像中的静态组件包括存储在映像或硬件(例如NVRAM)中的文件和数据。研究人员通常从下载的固件映像和物理设备中提取这些组件。提取保真度高意味着原始设备上的大部分成分被获得或提取，而当提取失败或产生不完整的结果时，提取保真度低。

**执行的保真度**。固件服务的执行保真度可能会因外设(与服务通信以执行特定任务的硬件组件，例如控制LED和读取传感器数据)的存在或不存在而受到影响。在模拟服务中低执行保真度的例子包括意外行为、通信中断(例如，无法登录到模拟的web门户)、过早退出或崩溃。实现高级别的执行保真度对于漏洞发现和评估至关重要，因为由低执行保真度引起的行为可能导致假阳误报(如果意外崩溃被视为漏洞指示器)或假阴误报(当易受攻击的代码没有在模拟中运行时)。

**执行保真度和提取保真度**。高提取保真度对于高执行保真度至关重要，因为配置项和文件内容可能会影响固件服务的行为。图1说明了重新托管需求的层次结构。较低的层次更基本，更容易实现，而较高的层次通常更难实现。Costin[9]从仿真级别的角度考虑了这个层次结构，“完美”仿真对应于重托管金字塔的顶端，其次是原始内核、通用内核、用户域仿真，最后是无仿真器(数据提取)。Jetset[20]将其分为不同的方法，每种方法的保真度都在不断提高:不进行仿真的测试、部分重新托管、完全重新托管和硬件在环仿真。

![](images/Pasted%20image%2020230810163655.png)

### 2.3 现存方法
表1对现有的重托管技术进行了分类。大多数解决方案要么倾向于实现动态分析的高执行保真度，要么通过纯静态分析[12]或基于模型的方法[17,20]完全回避这个问题。

![](images/Pasted%20image%2020230810164018.png)

在考虑仿真的执行保真度的情况下，研究人员倾向于使用操作系统级别的仿真器，如qemu系统。即便如此，真实设备和仿真环境之间的配置、软件和硬件差异往往是不可避免的。解决这些差异需要大量的手工工作。此外，操作系统级仿真带来了很高的性能开销，特别是对于模糊测试等动态分析技术。

或者，像Costin[9]这样的工作考虑使用用户空间仿真进行动态分析。尽管具有较低的开销，但在用户空间中重新托管会导致模拟服务的保真度显著降低，作者指出这是“相当不稳定的”[9]。

Frankenstein [27]， FirmAFL[40]和EQUAFL[41]使用的解决方案是使用来自真实设备或全系统模拟器的快照来增强用户空间仿真的保真度。这导致了模糊器和重托管目标之间的紧密耦合，从而阻碍了重托管技术的通用性。例如，FirmAFL需要大量的手工工作来利用每个新的固件目标(详见附录)。

### 2.4 动机
现有技术表明，固件重新托管要求高执行保真度。然而，对于固件的安全分析来说，高执行保真度通常是不必要的，特别是当目标漏洞不需要高保真度时。

我们对过去两年内关于NVD[25]的100个固件cve进行了采样，发现其中只有14%与硬件相关。剩下的许多本质上是独立于难以模拟的、特定于设备的特性和功能的。例如，腾达披露了AC21路由器的httpd可执行文件中的10个漏洞，这些漏洞都没有与外设交互[35]。

固件设计可能要求模拟服务在到达易受攻击的程序点之前加载配置项、与外设通信或调用特定于设备的功能。研究人员建议通过提供低保真替代品来克服这些障碍，而不是盲目地增加执行保真度，例如使用存根[5,21,32]或模型[14,17,42]创建有限的仿真。我们的见解是，我们可以使用类似的方法来处理用户空间重新托管的低保真部分。为了提高整个仿真环境的执行保真度，不需要对硬件组件进行粗糙的、高强度的重新实现，而只需绕过这些障碍，只关注与潜在易受攻击代码的执行直接相关的组件，就足以满足安全分析的目的。

由于大多数物联网漏洞只涉及一个固件服务，因此我们专注于单个固件服务的用户模式模拟。通过仅围绕固件服务重新创建必要的仿真，我们的目标是获得高执行保真度的好处，而无需昂贵的全系统仿真。这使我们能够显著提高执行速度和重托管服务的可移植性。

## 3.单服务重托管
Greenhouse重新托管使用基于linux的操作系统的Type-I IoT设备(如2.1节所定义)。我们选择路由器是因为它们代表了物联网设备中最大和最常研究的子集。我们将自己限制在以下32位架构的固件映像:MIPS、MIPSEL、ARM和X86，因为它们代表了大多数公开可用的固件映像。

**固件上的单个服务**。考虑一个设备上的固件，它有多个正在运行的进程，这些进程在执行期间不断地交换信息。我们可以根据这些流程之间的数据层次结构来定义服务。单个服务表示映像中自包含的一组进程，这些进程不与主进程不是父进程的任何其他进程通信。例如，web服务器可以调用几个脚本来动态地为用户生成HTML内容。web服务器是主要进程，它与脚本一起构成单个服务。

Greenhouse专注于重新托管这些类型的固件服务。为了最小化执行开销，我们使用QEMU-user在chroot文件系统中模拟服务二进制文件来重新托管服务，我们称之为单服务重新托管，而不是其他解决方案使用的全系统重新托管(通过QEMU-system)。单服务重托管在用户空间中运行目标服务二进制文件，并且不模拟任何内核模块。

## 4.Greenhouse 概述
Greenhouse是一个用于单个固件服务的单服务重新托管的自动化系统。它包括三个主要组件:运行器Runner、检查器Checker和修复器Fixer。对这些主要组件进行补充的是一个Extractor组件，它执行初始镜像提取，以及一Exporter组件，它将重新托管的结果打包以供以后使用。在Greenhouse之外，我们创建了一个爬虫模块，该模块构建了我们评估中使用的初始固件数据集。

![](images/Pasted%20image%2020230810171207.png)

由Greenhouse重新托管的固件映像从Extractor开始，在Runner, Checker和Fixer之间的迭代循环中度过大部分重新托管过程，最后通过Exporter作为独立的Docker容器退出该进程。这个过程是完全自动化的。

而其他研究如Firmadyne[5]、FirmAE[21]和Costin等[9]包含执行其中一个或多个步骤的类似组件，它们一次应用所有修复。Greenhouse监视固件服务的执行，并有选择地应用必要的修复，从而最大化修复机会，同时最大限度地减少对执行保真度的降低。据我们所知，ARI[26]是唯一一个迭代重托管的工作。

### 4.1 文件系统提取
像现有的重新托管解决方案[5,8,12,21,26,41]一样，Greenhouse使用Binwalk来提取安装了所有可选依赖项的文件。我们使用`-M` (Mashotrya)和`--preserve-symlinks`来运行Binwalk，以递归地从固件映像中提取根文件系统并保留符号链接。从理论上讲，Greenhouse支持重新托管任何类型的单一服务。在我们的评估中，我们重新托管HTTP web服务器，UPnP服务器和DNS服务器。

### 4.2 目标仿真
Runner是Greenhouse迭代重托管循环的核心，它通过QEMU-user在Docker容器中执行每个web服务器。



## 5.重托管指标
## 6.障碍和干预

## 10.结论
我们提出了Greenhouse，这是一个自动化系统，用于用户空间中基于linux的固件的大规模单服务重新托管。Greenhouse利用“尽最大努力”的缓解来迭代地使固件映像和模拟环境相互适应。我们还根据模拟动态分析和漏洞发现的最终目标，为重新托管定义了一组更严格的标准。我们在一组7,140个I型固件映像上评估Greenhouse，并根据我们的新标准将其中的2,841个重新托管到最低可用性水平。使用现有的分析工具，如routersplit和AFL，我们发现了717个n日漏洞和26个0日漏洞。这证明了单服务、用户空间仿真为动态分析创建可用的仿真镜像的可行性。
