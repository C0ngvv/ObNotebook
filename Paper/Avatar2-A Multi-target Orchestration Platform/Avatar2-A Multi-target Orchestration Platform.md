Workshop on NDSS Binary Analysis Research (BAR) 2018

# 翻译
## 摘要
动态二进制分析技术在研究软件系统的安全性和检测各种设备和应用程序中的漏洞方面发挥着核心作用。在过去的十年中，各种不同的技术已经发布，通常伴随着原型工具的发布来证明它们的有效性。不幸的是，大多数这些技术的实现都与它们的动态分析框架紧密耦合在一起，并且不容易集成到其他框架中。这些框架的设计目的不是向其他组件公开其内部状态或结果。这使得分析人员无法将不同的工具组合在一起，利用它们的优势来解决需要结合复杂技术的复杂问题。碎片化和隔离是两个重要的问题，它们经常导致重复的工作，或者对同一个问题产生多个等效的解决方案——每个解决方案都基于不同的编程语言、抽象模型或执行环境。

在本文中，我们介绍了avatar2，这是一个动态多目标编排框架，旨在实现不同动态二进制分析框架、调试器、模拟器和实际物理设备之间的互操作性。Avatar2允许分析人员在复杂的拓扑结构中组织不同的工具，然后将二进制代码的执行从一个系统“移动”到另一个系统。该框架支持设备/应用程序内部状态的自动传输，以及可配置的输入/输出转发和对物理外设或模拟目标的内存访问。

为了演示avatar2的使用和多功能性，在本文中，我们提出了三个非常不同的用例，其中我们复制了NDSS 2017上展示的PLC rootkit，我们测试了结合Angr和GDB的Firefox，我们使用PANDA和OpenOCD记录了嵌入式设备固件的执行情况。所有工具和三个用例都将作为开源发布，以帮助其他研究人员复制我们的实验，并使用avatar2执行他们自己的分析任务。

## 1.引言
我们的社会越来越依赖于计算系统，从低端嵌入式设备到大型基于云的系统。这些系统用于非常多样化的领域，从复杂的工业环境到较小的消费设备。然而，在所有计算系统中经常发现的大量软件漏洞使这种依赖性成为一个重大问题。因此，在这些系统上运行的软件需要仔细测试和验证，这通常不仅由制造商自己完成，而且由第三方公司和安全研究人员完成。虽然从源代码分析程序是一项重要的工作，但在软件作者和第三方中，仅二进制分析非常流行。第三方参与这项活动的动机是多种多样的，从签约执行额外黑盒测试的顾问，到作为bug赏金计划一部分搜索安全漏洞的个人，或者只是对减少流行软件产品中的bug数量感兴趣的研究人员。

当源代码可供分析人员使用或软件作为开放源代码可用时，纯二进制测试也是一种非常流行的选择。之所以会出现这种情况，是因为仅通过源代码检查无法发现一些细微的错误，而且二进制分析允许独立于用于开发系统的源代码语言测试软件。此外，不依赖于源代码意味着分析不依赖于编译器是正确的，也就是说，“你模糊测试的就是你发布的”。

因此，在过去的十年中，使用纯二进制方法的测试和分析软件变得越来越流行，并且已经发表了各种不同的二进制分析技术[23]。通常情况下，这些技术是在独立的工具中实现的，以证明它们的有效性。有些工具是简单的原型，而其他工具是更成熟的解决方案，这些解决方案多年来已经获得了显著的普及。现有的工具可能依赖于直接在目标分析主机或模拟器中执行的测试，甚至在专用的特定执行引擎中(例如，用于符号执行)。

>[23] Y. Shoshitaishvili, R. Wang, C. Salls, N. Stephens, M. Polino, A. Dutcher, J. Grosen, S. Feng, C. Hauser, C. Kruegel et al., “Sok:(state of) the art of war: Offensive techniques in binary analysis,” in IEEE Symposium on Security and Privacy. IEEE, 2016.

不幸的是，大多数这些技术的实现都与它们的动态分析框架紧密耦合在一起，并且不容易集成到其他框架中。通常，他们甚至重新实现其他工具的二进制分析技术部分，以受益于这些技术，因为每个框架的目标都是获得尽可能最好的分析。不幸的是，到目前为止，在不同框架之间更好的交互方面投入的努力很少，不仅在重用分析结果方面，而且在向外部组件共享内部分析状态方面。这使得分析人员无法将不同的工具组合在一起，利用它们的优势来解决需要结合复杂技术的复杂问题。碎片化和隔离是两个重要的问题，它们经常导致重复的工作，或者对同一个问题产生多个等效的解决方案——每个解决方案都基于不同的编程语言、抽象模型或执行环境。

在本文中，我们介绍了avatar2，这是一个我们开发的框架，用于促进多个二进制分析工具(如调试器、符号执行引擎和模拟器)之间的互操作性。我们的解决方案背后的基本原则是让分析人员选择多个执行环境，这些环境稍后用于在相同的执行状态下执行任务。实际上，我们将在本文中展示，在各种场景中，不仅将特定的分析保留在一个工具中是有益的，而且将其状态用作其他分析环境中的基本块。Avatar2是Avatar[29]的后继者，Avatar是一个最初设计用于执行嵌入式设备分析的系统，我们完全重新设计并扩展了它，以允许任意组件的轻松编排，这些组件可以组合起来执行复杂的二进制分析任务。

我们相信avatar2是为这种多目标编排提供通用框架的第一次尝试。特别地，本文在二进制分析领域做出了以下贡献:

- 我们展示了分析环境之间的状态转发不仅对嵌入式设备分析有用，而且是一种更通用的技术，允许在多个环境之间进行编排。
- 我们提出了avatar2，一个完全重新设计的系统，用于编排多个测试环境之间的执行。
- 我们展示了avatar2脚本如何帮助快速复制以前的研究，同时提高使用avatar2进行的研究的可重复性。
- 我们用三个非常不同的用例来演示avatar2的使用和多功能性，在这些用例中，我们复制了以前的固件研究，我们记录和回放了嵌入式设备的执行，我们分析了一个大型桌面应用程序。
- 我们强调跨多个工具协调执行的好处:GDB, OpenOCD, QEMU, anger和PANDA。
- 我们将所有工具和三个用例作为开源发布，以帮助其他研究人员复制我们的实验，并使用avatar2执行他们自己的分析任务。

本文的其余部分结构如下。首先，在第二节中，我们提供了程序分析的一般背景，并对avatar2的前身avatar[29]进行了总结。之后，我们介绍了avatar2框架(第三节)，然后通过三个案例研究(第四节)展示了它的有用性，突出了框架的有趣方面。然后我们讨论结果(第V节)，比较avatar2与相关工作(第VI节)，并以结束语结束论文。

## 2.背景
在描述avatar2框架之前，我们提供一些关于动态二进制分析主题的背景信息，以强调对多目标编排的需求。之后，我们简要讨论了avatar的前身——《avatar2的灵感来源——avatar的原始框架。虽然原始工具的目的仅仅是通过将S2E[5]连接到物理设备来实现嵌入式设备的动态二进制分析，但它引入了许多重要的概念，用于构建适合协调多个动态二进制分析工具的编排框架。

> [5] V. Chipounov, V. Kuznetsov, and G. Candea, “S2e: A platform for invivo multi-path analysis of software systems,” in 16th Intl. Conference on Architectural Support for Programming Languages and Operating Systems. ACM, 2011.

### A.动态二进制分析
程序分析通常分为静态分析和动态分析。静态分析仅仅通过检查代码来解释程序，而动态分析依赖于程序的实际执行。因此，静态分析可以通过分析程序的所有可能的执行路径来提供可靠的结果。

然而，使用静态分析时，程序的整个运行时状态是不可用的(例如，堆结构，一些指针或线程)，并且通常需要近似来确定其他不可确定的问题，这可能导致大量误报。动态分析通过分析程序在给定输入上执行时的实际行为来避免这些问题(以只能观察一小部分程序状态和代码为代价)。

动态分析的一个常见应用是安全性测试和评估，其目的是发现影响被分析程序安全性的错误。这些错误的常见示例包括身份验证绕过、内存损坏或内存泄露，这些都可能对潜在的攻击者有利。在这种情况下，仅基于机器码的二进制程序分析尤其重要，原因有二。首先，二进制代码是程序最精确的表示，因为它是直接在处理器上执行的代码。第二，尽管存在一个稳步增长的开放源码运动，但大量的程序只以二进制形式分发。这尤其适用于用内存不安全语言(如C和c++)编写的程序，由于它们的广泛部署，它们是攻击者的绝佳目标。

近年来，动态二进制分析的技术水平有了很大的提高，开发并提供了各种工具来辅助安全性测试。经典的方法要求在执行程序之前对被检查的二进制文件进行插装(动态或静态)。Valgrind[18]和AddressSanitizer[22]是遵循这种方法的流行工具示例。

动态分析的另一个相关用途是与符号执行引擎相结合，作为一种提供具体输入的方式来驱动符号探索(在传统上称为concolic执行)，或者作为一种由符号探索和约束求解驱动的沿着多条路径执行程序的方式。这种混合动力引擎的发展在过去十年中经历了复兴，分析师必须在几个框架之间做出选择，如angr [24]， BAP [2]， Manticore [27]， Miasm [10]， BINSEC/SE[8]或Triton[21]。

虽然每个解决方案都有自己的优点和缺点，但它们都有一个共同的属性:每个分析任务都绑定到自己的专用工具。这是由于多种原因造成的，包括不兼容的设计选择(例如使用特定于某个工具的中间表示或以自定义格式抽象表示程序状态)，或者开发人员经常将工具实现为独立的系统，这些系统的实现是为了灵活使用，但很难与其他解决方案集成。除了导致重复工作之外，由于不同的工具经常彼此独立地实现相同的动态二进制分析技术，这阻碍了二进制分析的全部潜力的释放。

### B.Aavatar 1
Avatar[29]是一个用于嵌入式设备的动态二进制分析框架。本质上，它允许在S2E(一个基于QEMU的符号执行引擎)内部对固件进行部分仿真。为了实现这个目标，不能模拟的I/O请求被转发到实际的嵌入式设备，或者通过专用的调试端口，或者通过使用手动注入设备的调试存根。

虽然Avatar只专注于允许S2E在嵌入式设备上工作，但它引入了以下概念，这些概念对于设计更通用的二进制动态分析编排框架起着重要作用:

- 目标编排。Avatar引入了编排的概念，不仅仅是作为一种控制其两个目标(S2E和物理系统)的方法，而且还作为基于分析师指定的特定事件自动将执行从一个工具转移到另一个工具的方法。
- 执行和内存分离。在传统的分析方法中，软件的执行和它的内存空间是紧密联系在一起的，而Avatar将它们解耦了。这允许框架使用所谓的远程内存，在其中一个目标上执行，而内存读写被转发到另一个目标。这允许Avatar实现部分仿真，而主固件在仿真器中执行，而对内存映射外设的访问被转发到实际设备。
- 状态转移和同步。除了编排执行之外，Avatar还提供了选择性地将状态从一个目标转移到另一个目标的可能性，其中状态由内存内容和CPU寄存器的组合定义。这允许Avatar在被分析的物理设备上执行初始化功能，然后将状态转移到S2E执行符号执行。

## 3.AVATAR2框架
正如第II-A节所讨论的，动态二进制分析可以从现有工具的互连中大大受益。在本节中，我们将介绍avatar2，这是我们开发的框架，通过连接调试器、模拟器和其他动态二进制分析框架来实现灵活的动态二进制分析。

### A.总体概述和术语








