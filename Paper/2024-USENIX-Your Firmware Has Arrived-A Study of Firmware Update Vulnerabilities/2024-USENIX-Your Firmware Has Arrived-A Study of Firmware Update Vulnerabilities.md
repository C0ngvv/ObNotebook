---
title: 2024-USENIX-Your Firmware Has Arrived-A Study of Firmware Update Vulnerabilities
date: 2023/12/15
categories:
  - 论文
tags:
  - 论文翻译
  - USENIX
---
# 2024-USENIX-Your Firmware Has Arrived-A Study of Firmware Update Vulnerabilities
## 基本信息
题目：你的固件已经到达:固件更新漏洞的研究

![](2024-USENIX-Your%20Firmware%20Has%20Arrived-A%20Study%20of%20Firmware%20Update%20Vulnerabilities/image-20231215164038033.png)

## 摘要
嵌入式设备在我们的社会中越来越普遍。固件更新是减轻嵌入式系统漏洞的主要机制之一。然而，固件更新过程也引入了新的攻击面，特别是通过易受攻击的固件验证过程。与内存损坏错误不同，固件更新中的许多漏洞源于不完整或不正确的验证步骤，而现有的固件分析方法不适用于此。为了弥补这一差距，我们提出了ChkUp，一种检查固件更新漏洞的方法。ChkUp可以通过跨语言的进程间控制流分析和程序切片来解析固件更新过程中的程序执行路径。通过这些路径，ChkUp定位固件验证过程，检查和验证其漏洞。我们实现了ChkUp，并对12,000个固件映像进行了全面分析。然后，我们在来自33个设备系列的150个固件映像中验证了警报，从而发现了零日和n日漏洞。我们负责地披露了我们的发现，在撰写本文时分配了25个CVE ID和1个PSV ID。

## 1.引言
嵌入式设备的快速增长，从智能手表等便携式设备到交通工具等大型机器，为我们的生活带来了更多的连接和便利。预计到2025年，嵌入式设备的市场规模将达到1162亿美元[10]。固件更新在修复漏洞和改进功能方面起着重要的作用。然而，实现不佳的固件更新机制可能会削弱这种优势，甚至引入新的攻击面。事实上，与软件更新相关的漏洞已经被认为是嵌入式设备的五大安全风险之一[12]。

**固件更新安全**。软件或固件更新是目前对抗网络攻击最有效的技术之一。然而，随着现代嵌入式系统连接性和复杂性的增加，越来越多的网络攻击专门针对固件更新过程，允许攻击者执行任意代码或回滚固件版本以暴露先前的漏洞[21,70]。最近Jeep Cherokee[52]、Samsung SmartThings Hub[8]和Asus Router[9]更新机制中的漏洞引起了人们的极大关注，凸显了自动识别固件更新漏洞的必要性。现有的固件漏洞检测方法通常侧重于识别用户控制输入对不安全sinks的调用[19,25,27,59,65]，或者使用常见的漏洞模式或已知规范的偏差来查找漏洞[24,33,49,50,64]。然而，固件更新漏洞构成了一个独特的挑战，因为它们通常来自跨多阶段更新过程的问题组合，由于缺乏全面的规范或系统的易受攻击模式分类而加剧。为了更好地了解固件更新漏洞的情况，我们对过去十年中与固件更新相关的CVE进行了分类和系统化。每种类型的漏洞都被放置在一般固件更新过程的不同抽象阶段，这在第2节中有详细介绍。

**我们的解决方案**-ChkUp。在本文中，我们提出了ChkUp，一种检查固件更新漏洞的新方法，包括缺少验证(例如缺乏版本检查)和不适当的验证(例如，使用MD5进行完整性检查)。直观地，ChkUp提取固件更新过程的程序执行路径，然后识别更新过程中的验证步骤链。然后，我们总结了多个固件更新阶段的漏洞模式，以进行漏洞检测。在进行此工作时，我们发现固件更新机制的现有实现存在独特的挑战，需要新技术。具体来说，有三个主要的技术挑战:

*C1.支持固件更新的多种系统组件*：在许多基于linux的固件映像中，各种类型的程序，如前端程序、脚本和二进制文件，被调用在软件更新执行路径中，跨越Web服务器的前端和后端。此外，固件更新中涉及的组件的多样性导致进程间通信(IPC)机制的异质性。为了应对这些挑战，我们开发了生成流程间更新流图(UFG)的技术。首先使用在固件更新过程中连接前端和后端的通用代码模式和语义信息来识别输入(entry)程序。然后，通过连接各个程序(即前端程序、脚本和二进制文件)的控制流并解析相应的IPC来提取跨语言控制流。有了这样一个跨语言、跨程序的控制流图，固件更新的执行路径可以使用带有固件更新特定语义的向后程序切片来解决。

*C2.验证程序识别*：固件更新是一个复杂的过程，包括各种检查和验证，从加密签名的验证到版本和设备ID的比较。只有当每个验证步骤(例如，签名验证或符合版本更新策略)及其组成得到适当实现时，更新过程才被认为是安全的。然而，固件更新没有标准化的规范，并且通常用多种编程语言实现。这导致了不同的验证实现，使得从执行路径中的众多功能中识别它们变得具有挑战性。为了应对这一挑战，ChkUp使用基于同构的数据流图(DFG)语义相似度匹配来识别固件验证过程。为了减少这个过程的开销，执行路径中的函数首先按照相似度评分进行排序，该评分是使用语法和结构特征计算的。然后，具有较高相似性分数的函数有限进行DFG同构的分析。

*C3.漏洞验证*：静态分析可能产生许多误报(FP)，这需要进一步的验证。但是，固件更新过程通常涉及一系列验证步骤，每个步骤都有其独特的功能和调用参数。为了测试链中后面的步骤，有必要创建能够通过前几个步骤的输入和环境。为了简化验证，我们提出了一种半自动的动态方法来验证可仿真固件映像的警报。具体来说，我们采用固件补丁来确保潜在的易受攻击程序的执行，然后根据输入恶意固件映像后的更新行为检查相应警报的有效性。

评价和发现。为了更深入地了解野外的漏洞，我们在12,000个固件映像上运行ChkUp。我们发现，弱验证算法，如使用MD5进行完整性验证，是普遍存在的。然后，我们对随机选择的150个固件映像进行漏洞验证:对于可仿真的固件映像，我们通过创建poc进行动态验证;对于其余的固件映像，我们进行了手动分析以验证它们的警报。我们的结果显示，真阳性率(TPR)为86.7%，假阳性率(FPR)为5.3%，导致在33个设备系列的固件映像中发现零日漏洞和n日漏洞。这些发现被负责地披露，并分配了25个CVE ID和1个PSV ID。最后，为了演示漏洞的可利用性，我们展示了固件降级和固件修改攻击。

**贡献**。我们的贡献概述如下:

- *固件更新安全的系统化*:我们将一般固件更新过程分为四个阶段，并通过分析和分类381个固件更新相关的CVE报告来检查每个阶段的安全问题。
- *更新漏洞检测的新方法*:我们提出了一种新的固件更新漏洞识别方法ChkUp，该方法解决了三个技术挑战:更新路径中的不同组件、验证过程识别和漏洞验证。
- *真实固件中的漏洞*:我们在12,000个固件映像上运行ChkUp，并使用概念验证(PoC)生成和手动分析相结合的方法验证其中150个固件的警报。结果证明了ChkUp识别零日漏洞和n日漏洞的能力。经过负责任的披露，已经分配了25个CVE ID和1个PSV ID。

## 2.固件更新安全系统化
### 2.1 固件更新挑战
为了更好地了解威胁形势，我们分析了过去十年中381个与固件更新相关的CVE，然后进行了系统化。虽然大多数CVE源于易受攻击的固件更新机制，但其他CVE只是对更新的安全性产生影响。图1显示了自2015年以来通用漏洞评分系统(CVSS) v3指标的年度分布。这一数字呈稳定增长趋势，从2020年到2021年，CVE的数量将翻一番。高、重度漏洞是低、中度漏洞的近4倍。这一增长不仅归因于CVE不断增加的总体趋势，还归因于嵌入式系统特有的新挑战[15,30,62,72 - 74,84,86]。这些挑战包括:1)由于连接性的增加，攻击面不断扩大;2)嵌入式系统的复杂性增加;3)产品生命周期长;4)嵌入式设备上的资源有限。这些因素导致了固件更新机制的多样化和漏洞的增加。

### 2.2 更新工作流和漏洞
典型的固件更新工作流有四个阶段，如图2所示:生成、交付、验证和安装。

![](2024-USENIX-Your%20Firmware%20Has%20Arrived-A%20Study%20of%20Firmware%20Update%20Vulnerabilities/image-20231215185954179.png)

**生成阶段**。生成阶段的目标是创建固件映像并使其可用。具体来说，作者首先开发了一个新的固件映像和一个清单。清单包含固件元数据，包括固件摘要、版本和设备ID。随后，使用数字签名对固件映像和清单进行签名，然后通过软件供应链将其传输到固件服务器。通常，作者通过在供应链中受信任方将固件上传到服务器。

在此阶段，外部攻击者可以进行供应链攻击以窃取证书并危害软件开发工具或基础设施。此类攻击的根本原因是对关键资产和基础设施的访问控制不当。近年来，越来越多的供应链相关漏洞被报道，这表明它们对现实世界的安全影响。报告显示，2020年，美国政府以及微软、英特尔和火眼等3万多家公共和私营组织遭受了大规模的软件供应链攻击，称为SolarWinds黑客攻击[55]。具体来说，网络犯罪分子入侵了Orion的IT管理软件，然后通过供应链向用户分发包含后门的恶意软件更新。

*结论1*:供应链漏洞带来了重大风险，通常来自不充分的访问控制。如果没有适当的设备上验证，受损的固件可能会安装在设备中，导致对设备的控制丧失。

**交付阶段**。交付阶段包括将新的固件映像从服务器传输到目标设备。一个固件组件，称为更新代理[46]，负责下载、验证和在持久内存中存储新映像。通常，新固件可以通过三种方式交付：1)固件服务器直接将固件和清单推送到设备的更新代理;2)更新代理轮询更新并在更新可用时下载更新;3)固件服务器通知设备用户/维护人员，设备用户/维护人员手动下载并上传更新到更新代理。在通信通道方面，常用的方法包括应用层协议(如HTTP、FTP)、无线媒体(如Wi-Fi、低功耗蓝牙)和物理接口(如USB、可移动存储卡)。对于一些低端的裸机设备，智能手机上的配套应用程序可以帮助进行固件更新。新的固件既可以捆绑在应用程序内部，也可以通过应用层协议从固件服务器获取。然后，这些应用程序通常通过无线媒体与设备通信，以进行通知、轮询和下载。值得注意的是，虽然应用程序充当传输固件的中介，但它们也可能预先验证更新。这样的早期验证可以过滤掉无效的更新，以避免不必要的后续设备上处理。

安全的通信通道对于交付的固件映像的机密性和完整性非常重要。不安全的交付主要源于缺乏加密协议或使用硬编码密钥，从而使系统暴露于中间机器(MITM)攻击之下。例如，CVE2020-9544涉及没有身份验证的纯HTTP，而CVE-2020-25233则来自使用硬编码的RSA密钥进行通信。移动应用程序也可能与固件服务器或设备进行不安全的通信，如CVE-2018-3928所示，其中通信安全检查不足可能导致代码执行漏洞。重要的是，主要问题不仅仅是通信通道，还包括缺乏适当的安全验证。例如，即使泄露了通信密钥，如果有一个健壮的固件验证机制，就可以防止在更新期间恶意替换固件。





## 参考链接

