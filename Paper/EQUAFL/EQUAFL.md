# Efficient Greybox Fuzzing of Applications in Linux-Based IoT Devices via Enhanced User-Mode Emulation

![](images/Pasted%20image%2020230321210045.png)

## 摘要
灰盒模糊已经成为最有效的漏洞发现技术之一。然而，灰盒模糊技术不能直接应用于物联网设备中的应用。主要原因是执行这些应用程序高度依赖于特定的系统环境和硬件。为了在基于linux的IoT设备中执行应用程序，大多数现有的fuzzing技术都使用了全系统仿真，以最大限度地提高兼容性。但是，与用户模式仿真相比，全系统仿真的开销很大。因此，以前的一些工作，如FirmAFL，提出将全系统仿真和用户模式仿真结合起来，以加快模糊过程。尽管尝试将应用程序转换为用户模式模拟，但没有现有技术支持在用户模式模拟中完全执行这些应用程序。

为了解决这个问题，我们提出EQUAFL，它可以自动设置执行环境，在用户模式模拟下执行嵌入式应用程序。EQUAFL首先在全系统模拟下执行应用程序，并观察在用户模式模拟期间程序可能卡住甚至崩溃的关键点。使用观察到的信息，EQUAFL可以迁移用户模式仿真所需的环境。然后，EQUAFL使用增强的用户模式仿真来重放网络的系统调用和资源管理行为，以满足嵌入式应用程序在执行期间的需求。

我们在来自不同系列物联网设备的70个网络应用上评估EQUAFL。结果表明，EQUAFL的性能优于最先进的模糊效率(平均比AFL-QEMU快26倍，比FirmAFL快14倍)。我们还从测试的固件映像中发现了10个漏洞，包括6个cve。

关键词：灰盒模糊测试，基于linux的物联网设备，增强的用户模式仿真

## 1.引言
随着物联网(IoT)的快速发展，数十亿物联网设备连接到互联网。与传统IT厂商相比，物联网设备厂商更注重系统功能，而不是系统安全性。因此，物联网系统中运行的应用程序存在各种未知的漏洞，为攻击者提供了大量的攻击面。例如，2016年底，Mirai病毒被开发出来，利用基于linux的物联网设备的漏洞，对美国东海岸发起了大规模DDoS攻击。这一事件对网络空间安全产生了重大影响。总之，安全研究人员需要尽快找到基于linux的物联网设备内部的漏洞，特别是那些作为物联网设备和互联网之间的大门的应用程序。

灰盒模糊是一种实用的测试技术，用于发现软件中的漏洞。灰盒模糊的基本思想是使用轻量级的程序插桩来收集被测程序(PUT)的执行反馈，例如代码覆盖率，以指导整个测试过程。尽管灰盒模糊对运行在桌面环境中的常规程序表现出了良好的性能，但它不能直接应用于运行在嵌入式设备中的应用程序。这主要是因为缺乏执行应用程序的系统和硬件支持。为了解决这个问题，现有的greybox fuzzing技术使用仿真技术来执行嵌入式应用程序[34,51]。

现有的仿真技术(如QEMU)既支持用户模式仿真，也支持全系统仿真。与全系统仿真相比，用户模式仿真以兼容性为代价享受了更小的执行开销，因为无法模拟系统调用和执行上下文。因此，现有的大多数灰盒模糊技术使用全系统仿真来执行嵌入式应用程序。然而，由于模拟整个系统的沉重开销，这种方法存在效率问题。为了提高仿真效率，Firm-AFL提出了一种在用户模式仿真和全系统仿真之间进行智能切换的技术。Firm-AFL的机制是，它允许应用程序在用户模式下运行，只要它没有执行系统调用，当应用程序遇到系统调用时，Firm-AFL将切换到全系统模拟以获取系统调用结果。与全系统仿真相比，Firm-AFL提高了执行速度，但当PUT涉及大量系统调用时，这种改进就可以忽略不计了。因此，现在的挑战是，我们能否在用户模式模拟下完全执行嵌入式应用程序，而不牺牲太多兼容性?

为了解决基于linux的物联网设备中模糊化应用的挑战，我们提出了EQUAFL，这是一个通过增强的用户模式仿真增强的灰盒模糊化框架，它具有高效率和高兼容性。增强型用户模式仿真的基本机制是自动设置执行环境，以便PUT的系统调用可以直接传递给主机。这样，PUT可以完全在用户模式模拟中执行，避免了系统调用模拟所引起的开销。为了自动地为PUT设置执行环境，EQUAFL使用了观察回放策略。首先，EQUAFL使用全系统仿真执行PUT，并观察系统的关键行为，如设置启动变量、生成配置文件、网络操作等。然后，EQUAFL将重放观察到的系统行为，以建立PUT的执行环境。不同的系统行为需要不同的观察和回放方法，其中最复杂的两种行为是动态配置文件生成和网络交互。前者在观察时需要进程感知，在重播时需要文件系统同步。后者需要状态感知的观察和重放。

我们在基于linux的物联网设备中的70个实际应用程序上评估了EQUAFL的兼容性和效率。结果表明，EQUAFL在执行速度方面优于AFL-QEMU(平均快26倍)和Firm-AFL(平均快14倍)。在实验中，EQUAFL在18个嵌入式设备中发现了10个以前未知的漏洞(包括6个cve)，证明了它在现实世界漏洞发现中的有用性。

**贡献**。综上所述，我们作出以下贡献:

- 我们提出了一种新的EQUAFL技术，它可以在用户模式下自动设置执行环境来完全模拟嵌入式程序。增强的EQUAFL用户模式仿真可以保证高兼容性和高效率。
- 我们基于AFL和QEMU实现了EQUAFL作为覆盖引导的灰盒模糊框架。
- 我们在来自主要嵌入式设备供应商的不同产品系列的70个真实网络应用上广泛评估了EQUAFL。结果表明EQUAFL具有较高的相容性和效率。此外，我们还发现了10个0日漏洞，其中包括6个带有EQUAFL的cve
- 我们在https://github.com/zyw-200/EQUAFL上发布了EQUAFL的源代码，以促进未来的研究。

## 2.背景
### 2.1 基于仿真的Fuzzing

## 3.概述
本系统的目标是在物联网设备中实现基于linux的网络应用程序的高效灰盒模糊。正如在2.1中所讨论的，目前的模糊工作存在性能或兼容性问题。用户模式仿真的AFL一方面保证了较高的模糊速度，但兼容性较差。另一方面，具有全系统仿真的AFL能够成功地模拟更多的目标应用程序，但效率较低。为此，我们建议以一种创新的方式将全系统仿真和用户模式仿真结合起来，开发一个满足两个要求的fuzzer:
- 高兼容性:应用程序的行为应该与全系统模拟相同。
- 效率高:模糊的速度要尽可能快

我们提出的模糊器称为EQUAFL，它是一个基于afl的框架，通过增强型QEMU用户模式仿真。图1显示了EQUAFL的工作流程，包括两个主要步骤:观察和回放。在观察阶段，EQUAFL通过全系统仿真来执行PUT，并观察系统的关键行为。根据图2.1中讨论的故障原因，系统的关键行为包括启动变量的设置、文件生成、NVRAM相关操作、网络交互、进程资源限制等。在这些行为中，最复杂的两个行为是动态配置文件生成和网络交互。因此，我们建议通过进程感知来观察动态配置文件生成和NVRAM配置(4.2和4.3)。同时，我们提出用状态感知来观察网络行为(4.4)。此外，我们使用几个启发式来观察其他信息，如启动变量和进程资源限制(4.1和4.5)。在重播阶段，EQUAFL通过在主机上部署系统资源(如动态配置文件)或在用户模式模拟期间执行系统调用执行的拦截来执行重播。在观察和重放仿真系统中的关键行为之后，PUT可以在增强的用户模式仿真中完全执行，从而避免了将系统调用执行委托给全系统仿真所引起的开销。最后，通过调整PUT生命周期管理和fuzzing的入口点，我们将增强的用户模式仿真与AFL fuzzer集成在一起，以便EQUAFL可以模糊从网络接收输入的物联网应用程序。

![](images/Pasted%20image%2020230321212334.png)

## 4.方法
### 4.1 启动变量处理
启动变量指的是模拟系统中PUT启动时使用的参数和环境变量。如果没有正确的启动变量，PUT可能会提前终止，因此在用户模式模拟中执行PUT时，我们需要确定启动变量。这里我们将PUT表示为𝑝∗，将其程序名称、参数和环境变量表示为𝑝∗𝑛𝑎𝑚𝑒、𝑝∗𝑣𝑎𝑟𝑠和𝑝∗𝑒𝑛𝑣𝑠。通常，这些变量以不同的方式存储在嵌入式固件中，包括写入配置文件，硬编码为二进制可执行文件，甚至由父进程传递。因此，很难通过静态方法实际提取这些参数。相反，我们建议通过对Linux内核进行静态模式分析和在全系统仿真期间进行运行时分析来获得𝑝∗𝑣𝑎𝑟𝑠和𝑝∗𝑒𝑛𝑣𝑠的具体值。

**观察**。基于Linux内核在启动新程序时调用execve系统调用的事实，我们在全系统模拟期间通过检测内核函数do_execve来转储新启动程序的𝑝𝑛𝑎𝑚𝑒、𝑝𝑣𝑎𝑟𝑠和𝑝𝑒𝑛𝑣𝑠。由于do_execve是Linux内核的一个通用体系结构部分，因此可以安全地假设大多数基于Linux的固件不会修改该代码。因此，通过分析Linux内核的源代码，我们总结了一个二进制模式，该模式可用于在模拟固件时定位用于转储这些启动变量的确切组装指令。具体地说，我们发现了三个函数调用指令(一个调用copy_strings_kernel，另两个调用copy_strings)，它们包含可用于计算𝑝𝑛𝑎𝑚𝑒、𝑝𝑣𝑎𝑟𝑠和𝑝𝑒𝑛𝑣𝑠地址的寄存器。然后，我们从这些指令中找到一个最近的后续基本块，在那里QEMU可以进行操作。最后，我们在系统模拟期间将值转储到该基本块。具体来说，我们选择的基本块正是函数search_binary_handler的入口点。

**重放**。经过观察，我们得到了一个集合(𝑝𝑛𝑎𝑚𝑒，𝑝𝑣𝑎𝑟𝑠和𝑝𝑒𝑛𝑣𝑠)，可以用来表示固件仿真过程中不同的进程。然后我们认识𝑝𝑣𝑎𝑟𝑠和𝑝𝑒𝑛𝑣𝑠作为目标𝑝∗𝑣𝑎𝑟𝑠和𝑝∗𝑒𝑛𝑣𝑠,哪里𝑝𝑛𝑎𝑚𝑒等于𝑝∗𝑛𝑎𝑚𝑒。在模糊化过程中，我们利用用户模式模拟，用𝑝* 𝑣𝑎𝑟𝑠和𝑝* 𝑒𝑛𝑣𝑠执行𝑝*。最终，PUT可以在用户模式模拟中运行到深度状态以进行进一步测试。

### 4.2 文件系统状态同步


