# Detecting Vulnerabilities in Linux-Based Embedded Firmware with SSE-Based On-Demand Alias Analysis

![](images/Pasted%20image%2020231018111655.png)

ISSTA 2023

# 翻译
## 摘要
尽管使用静态污染分析来检测基于linux的嵌入式软件中的污染类型漏洞的重要性已得到广泛认可，但现有方法存在以下主要局限性:(a)现有工作不能正确处理从攻击者控制的源到安全敏感的接收器的路径上的间接调用，导致大量误阴性。(b)他们采用启发式方法来确定中间污染源，但这种方法不够准确，导致误报率很高。

为了解决这些问题，我们提出了EmTaint，这是一种新的静态方法，用于准确快速地检测基于linux的嵌入式固件中的污染类型漏洞。在EmTaint中，我们首先设计了一个基于结构化符号表达式(SSE)的按需别名分析技术。在此基础上，提出了间接调用解析和精确的污点分析方案。EmTaint与消毒规则检查相结合，最终可以在有限的时间内准确地发现大量的污染式漏洞。我们将EmTaint与来自六个流行供应商的35个真实嵌入式软件样本进行了评估。结果显示，EmTaint发现了至少192个漏洞，其中n天漏洞41个，0天漏洞151个。在撰写本文时，已从报告的漏洞子集中分配了至少115个CVE/PSV编号。与KARONTE和SaTC等最先进的工具相比，EmTaint在更短的时间内在同一数据集上发现了多得多的漏洞。

关键字：按需别名分析，污点分析，嵌入式软件

## 1.引言
随着物联网技术的兴起，嵌入式设备在我们的日常生活中得到了广泛的应用。为了快速开发，设备厂商倾向于定制Linux内核，并编写基于Linux的嵌入式固件来管理和控制设备。例如，几乎所有主流的无线路由器都配备了基于linux的嵌入式固件。然而，由于厂商缺乏全面的安全评估，基于linux的嵌入式固件存在大量未被披露的漏洞，这给网络空间安全带来了重大的重大影响。在各种漏洞类型中，污点类型漏洞是一种典型的漏洞类型，用户输入未经适当检查或处理就可以到达安全敏感的sink[41]。由于路由器、网络摄像头等基于linux的嵌入式设备与外界的通信频繁，因此更容易触发污点型漏洞，因此我们需要对其进行优先级检测。

静态污点分析是一种有效的技术，用于发现嵌入式软件中的污点式漏洞，例如KARONTE[30]和SaTC[7]。它可以用来执行整个分析固件，而不需要仿真和真实的设备。在静态污点分析中，污点源指的是接收用户输入的库函数(例如，recv、recvfrom)，而污染汇聚点指的是安全敏感的库函数(例如，strcpy、system)，这些函数可能被利用来导致内存损坏或命令注入。污点分析的基本思想是寻找从污染source到sink的数据流路径(我们称之为潜在漏洞路径)，然后对路径进行安全检查，推断是否存在漏洞。

**挑战**。然而，对于嵌入式二进制文件的污染分析来说，有效地揭示潜在的漏洞路径是一个具有挑战性的问题。原因是双重的。一方面，在基于linux的固件的后端，大多数潜在的漏洞路径涉及间接调用(参见§4.3)，其中一些无法直接解决。因此，目标二进制文件中仍然存在许多潜在的易受攻击路径。另一方面，变量别名的频繁出现也使得数据分析技术无法发现隐含的潜在漏洞路径。为了缓解这些挑战，最新的研究[7,30]利用启发方法识别中间污染源作为原始污染源的替代方案，从而缩短从用户输入到汇聚点的潜在易受攻击路径的长度，从而减少遇到间接调用和变量别名问题的概率。不幸的是，这些方法有时会错误地识别后端二进制文件中的中间污染源，从而导致潜在的易受攻击路径的误报。同时，由于联系的困难性，这些工作中仍然没有考虑间接调用解析，因此许多潜在的脆弱路径没有被发现，从而产生了许多假阴性。

我们的解决方案。在本文中，我们旨在通过解决间接调用和隐式数据带来的问题，全面、准确地揭示从污染源到污染池的潜在脆弱路径。我们的见解是，准确的别名分析可以在污染传播期间促进间接调用解析和隐式数据分析。为此，我们提出了一种基于结构化符号表达(SSE)的按需别名分析技术。该技术从两个方面克服了现有别名分析技术(基于vsa或基于符号执行的方法)的缺点。首先，我们设计了一种新的符号表达式来表示别名信息，与现有的方法相比，提高了别名分析的准确性。其次，该技术只关注感兴趣的变量(间接调用目标和受污染的变量)来执行按需分析，避免了对其他不相关变量的整体分析。

在基于SSE的按需别名分析的基础上，我们提出了EmTaint，它可以有效地检测基于linux的嵌入式固件中的污染型漏洞。EmTaint的设计如下。首先，EmTaint从嵌入式固件中提取目标二进制可执行文件，并构建用于进一步静态分析的基本程序表示。然后，EmTaint执行基于SSE的按需别名分析，这可以帮助找到间接调用目标与函数指针之间的别名关系。在此基础上，EmTaint设计了间接调用解析和精确的污点初始化和传播方案。最后，EmTaint集成了消毒规则检查，可以有效地检查发现中基于linux固件中的污染型漏洞。

我们已经用Python实现了大约24000行EmTaint的原型。在EmTaint中，基本的程序表示是通过使用IDA Pro[22]、CLE[11]、pyvex[29]来构建的。本文提出的基于sse的按需别名分析和间接调用解析是基于Claripy开发的[10]。我们用35个真实的固件样本来评估EmTaint。结果显示，EmTaint至少发现了192个漏洞，其中n天漏洞41个，0天漏洞151个，平均每个样本耗时3分钟。我们已经向相关制造商报告了151个0天漏洞，以进行负责任的披露。在撰写本文时，115个漏洞已被CVE/PSV确认。我们还与最先进的KARONTE[30]和SaTC[7]进行了比较。对比结果表明，EmTaint可以在更短的时间内发现更多的漏洞。此外，我们在2021年的DataCon竞赛中使用EmTaint进行物联网固件漏洞检测，最终获得第一名，这证明了EmTaint在现实世界中的效率。

贡献。我们的贡献如下:

- 我们提出了一种新的别名分析技术，称为基于sse的按需别名分析，以应对有效地揭示了污染分析的潜在脆弱路径的挑战。
- 我们提出了EmTaint，这是一种用于检测基于linux的嵌入式固件中的污点型漏洞的新方法。原型是用Python实现的，大约有24,000行。
- 我们通过大量的实验来评估EmTaint。结果证明，EmTaint在检测基于linux的固件中的污染类型漏洞方面优于最先进的工作。此外，EmTaint在35个嵌入式固件样本中发现了151个0天漏洞(其中115个带有cve/psv)。
- 我们在https://sites.google.com/view/emtaint/home上发布了EmTaint的源代码和实验数据，以供将来的研究。

## 2.背景和动机
### 2.1 污点型漏洞检测
给定一个嵌入式二进制文件，检测污染类型漏洞的标准污染分析过程包括四个步骤。(1)恢复程序间控制流图(ICFG)。(2)识别攻击者控制的源和安全敏感的sink。(3)找到一条污点从源传播到sink的路径。(4)检查sink点污染数据的约束。如果没有约束，则会引发有关该漏洞的警报。理想的解决方案应该在所有这些步骤中实现高精度。

### 2.2 动机案例
然而，如何有效地揭示从污染源到接收器(步骤3)的完整路径是一个具有挑战性的问题。主要原因是嵌入式设备中的服务程序经常注册回调函数来处理不同类型的用户请求，从而阻止了从源到接收器的污染传播。只有在执行期间指定用户请求，间接调用目标可以被分配一个回调函数。这意味着，在执行静态污染分析时，间接调用目标仍然是未知的，因此污染分析将卡在这些点上。

图1显示了间接调用如何防止污染分析技术查找NETGEAR DGN2200路由器中的命令注入漏洞的示例。首先，后端接收来自前端的请求，并通过getReqName函数获取URL dnsloopup.cgi，并将其存储在变量name中(第10行)。然后，后端在注册用于处理dnsloopup.cgi(第12行)的全局函数表中搜索函数指针，最终调用函数diagCgiDnslookup(第13行)。diagCgiDnslookup函数包含命令注入漏洞：cmd的值来自用户请求(前端用红色标记)，没有进行任何清理检查。攻击者可以将额外的命令附加到字符串“router”上，从而在设备上运行任意命令。然而，在静态污染分析中，\*fn(第13行)是未知的，因此污染分析无法到达system函数和以及此潜在漏洞。

![](images/Pasted%20image%2020231018153346.png)

SaTC[7]、KARONTE[30]等现有研究采用启发法推断中间污染源作为用户输入的代表，从而缩短了污染源到汇点的距离，降低了污染分析的复杂性。然而，它们仍然有局限性。首先，识别中间污染源的启发式方法仍然会产生大量的假阳性和假阴性。特别是，SaTC利用来自前端web文件和后端二进制文件的共享接口关键字来识别中间污染源。但是，部分用户输入的关键字在前端web文件中不存在。例如，在NETGEAR R7800路由器固件版本V1.0.2.58中，在前端web文件中找不到关键字hidden_funjsq_username，导致SaTC无法识别，但该关键字的值可能导致命令注入漏洞。其次，间接调用问题仍然存在于从中间污染源到sink的短路径中，这在现有的工作中没有考虑到，导致在揭示脆弱路径时出现假阴性。

### 2.3 挑战与核心理念
通过对最新工作的研究和对激励示例的观察，我们总结了在基于linux的固件中检测污染类型漏洞的两个挑战。首先，当路径上涉及间接调用时，如何找到从实际输入源(例如，recv函数)到接收器的完整路径。二是如何在路径较深的情况下有效地检测漏洞。

为了解决上述两个挑战，我们提出了基于SSE的按需别名分析，它可以作为间接调用解析和精确有效污染分析的基本技术。基于SSE的按需别名分析可以从两个方面进行解释。首先，受访问路径[8]的启发，我们设计了一种新的符号表达式，称为结构化符号表达式(SSE)。但是，访问路径针对的是源代码，而不是二进制文件。SSE可以准确描述嵌套的内存访问变量(如x.y.z)，保证别名分析的准确性。与符号执行中使用的符号表达式不同，SSE对算术操作和内存操作(如加载和存储)进行编码。因此，给定变量的任何形式的别名都可以通过SSE精确地表示。其次，我们进行按需分析以确保别名分析的效率。这意味着，只需要跟踪感兴趣的变量，例如间接调用目标和受污染的变量，从而避免了耗时的整体分析。在基于SSE的按需别名分析的基础上，我们采取了处理间接调用的策略并实现准确的污染传播。之后，我们可以有效地揭示从输入源到安全敏感sink的完整潜在脆弱路径。

## 3.方法
### 3.1 概述
EmTaint将嵌入式固件映像作为输入，并将潜在的污染类型漏洞作为输出报告。如图2所示，EmTaint由四个主要组件组成。

**固件预处理**。固件预处理模块从固件解压提取二进制文件。然后，该模块将二进制代码转换为中间表示(IR)。之后，它构建控制流图(CFG)和部分调用图(CG)，以方便后续分析。

**基于SSE的按需别名分析**。别名分析引擎定义了一种新的结构化符号表达式(SSE)来准确地表示别名信息，并设计了别名更新机制，以发现别名贯穿整个二进制可执行文件。为了实现按需分析，它只计算与感兴趣的变量相关的别名。这将避免为大量不相关变量计算别名的开销，从而可以将分析应用于复杂的固件二进制文件。

**间接调用解析**。利用所提出的基于SSE的别名分析引擎提供的数据依赖性信息，我们进一步设计了一个间接调用解析算法，该算法检查间接调用点与引用的函数指针(或函数表指针)之间的数据依赖性。该机制有助于后续的污点分析跨越更多的功能边界，提高污点类漏洞的发现能力。

**污点类型漏洞检查**。污点类型漏洞检查模块负责识别潜在的污点类型漏洞。特别是，它首先污染由攻击者控制的污染源上的变量(例如，recv函数)。然后，它通过按需别名分析模块和污染传播操作捕获污染传播。最后，在安全敏感的sink点(例如，system函数)，如果相应的变量被污染且不受约束，我们将其标记为潜在的漏洞。由于污点类型漏洞检测的高级思想与[3,7,30]一致，所以我们在[37]中包含了详细的过程描述。

### 3.2 基于SSE的按需别名分析
在本节中，我们首先从结构化符号表达式(SSE)的定义开始。然后，我们用SSE对按需别名分析问题建模。在此基础上，我们描述了如何对每条指令执行SSE更新。

### 3.2.1 SSE的定义
