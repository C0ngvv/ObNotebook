# UCRF: Static analyzing firmware to generate under-constrained seedfor fuzzing SOHO router


![](images/Pasted%20image%2020231114110818.png)

2023 Computers & Security

## 摘要
SOHO(小型办公室和家庭办公室)路由器是物联网的关键要素，为各种智能设备提供网络服务。近年来，针对SOHO路由器网络应用程序的攻击越来越多。web服务器在直接接收和处理外部数据的过程中引入了大量的漏洞。模糊测试是发现此类漏洞最常用的技术。以前提出的方法通过分析前端以有效格式生成模糊种子。不幸的是，生成的种子受到前端代码合法性检查的过度约束，因为恶意数据可以绕过前端检查而直接发送到后端。而且，这种种子忽略了后端的语义，使得后端的检查逻辑阻碍了模糊测试的效率。

在本文中，我们提出了一种通过静态分析后端二进制文件生成高质量测试用例来模糊SOHO路由器的新方法。具体而言，我们首先获得后端所有通信接口，以避免丢失不可见的前端接口。然后，对每个接口进行数据流分析，提取所有数据字段的约束信息。最终，有效和深入的测试用例只能在基于约束信息的有意义的测试空间中生成。我们在一个名为UCRF的工具中实现了我们的方法。为了说明UCRF的有效性，我们对来自4家供应商的10个真实固件进行了评估。UCRF在我们的5个路由器上发现了比最先进的SRFuzzer更多的内存损坏和命令注入漏洞。此外，UCRF共发现41个0天后端漏洞，其中20个只有在满足提取的约束条件时才能触发。

## 1.引言
物联网(IoT)设备越来越多地应用于人们的日常生活中(Alrawi et al, 2019)。根据全球移动通信系统协会(GSMA)的报告(the Mobile Economy, 2022)，到2021年，全球物联网设备总数已达到151亿，预计到2025年将增长到233亿。SOHO (Small office and home office)路由器被广泛用于为智能家居、笔记本电脑、智能手机等各种设备提供网络服务，因此SOHO路由器的安全性至关重要。不幸的是，由于嵌入式系统资源有限，SOHO路由器中缺少常见的安全机制(Smart Yet flaws, 2020;Thompson and Zatko, 2018;Yu et al, 2022)，并且许多漏洞可以被攻击者远程利用(Cisco Small, 2022;Dir, 2022)。例如，2016年，Mirai僵尸网络入侵了数百万台物联网设备，并对互联网基础设施公司Dyn发起了分布式拒绝服务(DDoS)攻击，导致欧洲和北美的大规模互联网服务中断(Kolias等人，2017;Mirai, 2016;结束,2018;旅行路由器，2017)。

路由器易受攻击的一个重要原因是它们内部易受攻击的web服务(Cisco Small, 2022;Costin et al, 2016)。SOHO路由器提供自定义web服务器供终端用户配置。web服务器通常包含前端(HTML和JavaScript等)和后端(如web服务器和公共网关接口)。用户数据在前端输入，并通过超文本传输协议(Hypertext Transfer Protocol, HTTP)发送到后端进行进一步处理。恶意用户网络数据很容易绕过前端检测(例如，中间人攻击)，被发送到后端进行处理。最终，该漏洞被利用来泄露信息或使设备崩溃。

近年来，人们提出了许多针对SOHO路由器的漏洞发现方法，包括静态分析(Chen et al .， 2021;Cheng等，2021;2018;Redini等人，2020)和动态测试(例如，模糊测试)(Srivastava等人，2019;Wang et al .， 2013;Zhang等，2021;2019;郑等，2019a;2019 b)。静态分析具有天然的局限性，存在许多误报(Shoshitaishvili等人，2016;Vadayath et al, 2022)。为了验证漏洞警报和编写概念验证(PoC)脚本，引入了大量的手工工作。模糊测试是一种流行的漏洞发现技术。固件仿真提供固件的运行时信息，包括代码覆盖率，这些信息可用于指导模糊测试。然而，由于外设依赖性，仿真自定义固件需要大量的手工工作(Chen等人，2016;Kim et al, 2020;Zaddach et al .， 2014)。为了避免固件仿真中的问题，一些研究工作选择直接对物理路由器进行测试。然而，如果没有有效信息的指导，生成有效的测试用例并执行深入的测试是具有挑战性的，这最终会导致大量的假阴性。

现有的物理SOHO路由器模糊测试方法基于前端生成测试用例(Srivastava et al .， 2019;Zhang et al .， 2019)。例如，这些方法模拟前端的行为，并生成请求作为模糊测试的种子。但是，前端严格验证输入数据的有效性，这使得生成的种子受到过度约束。换句话说，输入数据的合法性检查只发生在前端，而不是后端。然而，后端错误地假设所有外部数据都已经过清理，而没有检查合法性。有经验的攻击者可以绕过前端检测，将恶意数据发送到后端直接利用漏洞。此外，基于前端生成的种子缺乏后端代码的语义信息。因此，很难满足网络数据处理逻辑，并在后端触发深度路径。此外，前端的爬行通信接口可能会错过不可见的接口，这些接口只出现在后端。总之，基于前端的模糊方法限制了漏洞发现的效率和范围。

我们的关键观察是，后端代码的语义可以帮助生成具有有效格式和约束信息的种子，以便在不考虑前端的情况下进行模糊测试。然而，提取后端语义信息来指导模糊测试并不是一项简单的任务。我们面临以下挑战:i)需要正确识别潜在的通信接口，这是测试用例不被丢弃的基本条件。ii)后端代码严格检查不同通信接口的数据字段组成和内容，这是影响代码测试范围的关键因素。

本文提出了一种基于路由器固件静态分析的自动、高效模糊测试框架UCRF (underconstrained router fuzzer)。UCRF根据其特征识别后端所有通信接口，包括不可见的前端接口。然后，通过对每个接口的数据流分析，提取出所有数据字段的三种约束类型。在后端代码中对特定字段中的数据验证约束，满足约束的数据字段可以通过条件检查，并触发受检查保护的更深层代码。最后，根据约束信息，UCRF将结构良好的种子集合起来，并在有意义的测试空间中进行变异，生成测试用例。

我们实现了解决方案UCRF的原型，并在4家供应商的10台流行路由器上运行。UCRF发现了41个零日漏洞，并分配了38个CVE ID, 2个CNVD ID和1个PSV ID。在我们的5个路由器上，UCRF发现的内存损坏和命令注入漏洞明显多于最先进的SRFuzzer。此外，我们评估了接口识别和约束信息。实验结果表明，UCRF识别后端通信接口的准确率为96.3%。对于约束信息，UCRF平均可以找到36.4%的参数关键字的约束(条件计算的固定值或数值范围类型)。请注意，只有在满足约束的情况下才能触发20个漏洞。

综上所述，我们在本文中做出了以下贡献:
- 我们提出了一种新的方法来生成有效的路由器模糊测试用例。我们首先通过对后端二进制文件的静态分析生成结构良好的种子，而不分析前端。进一步，提取数据字段的三种约束类型，仅在有意义的测试空间中引导种子突变，实现有效的测试空间探索。
- 我们实现了原型系统UCRF，这是一个用于SOHO路由器发现后端漏洞的自动模糊测试框架。UCRF在后端识别所有潜在的通信接口，以避免丢失不可见的前端接口，并生成特定于接口的种子。然后，UCRF利用轻量级数据流分析以低开销提取后端二进制数据字段的约束。
- 我们在4家厂商的10台SOHO路由器上对UCRF进行了评估。共发现41个0天漏洞，其中20个只有满足提取的约束条件才能触发，说明基于后端语义生成的种子对漏洞发现是有效的。

在第2节中，我们介绍了SOHO路由器的背景知识，并通过一个示例说明了当前模糊器的局限性。第3节概述了UCRF并描述了详细的设计。在第4节中，我们描述了UCRF的实现，并在第5节中使用真实设备评估了UCRF。在第6节中，我们讨论了UCRF的局限性并提出了未来的工作。在第7节中介绍了与本文相关的研究工作，最后在第8节中对本文进行了总结。

## 2. 背景与动机
### 2.1. SOHO路由器系统
SOHO路由器被广泛用于为各种设备提供网络服务。SOHO路由器通常通过web服务器为最终用户提供一个交互界面，以便正确地连接到Internet并启用网络服务。web服务器通常包含两个组件:前端和后端，它们都包含在固件中。前端是用于用户交互的网页，包括HTML、Javascript等文件。用户在前端输入的数据通过HTTP发送到后端进行处理。在后端，特定的二进制文件(例如httpd)接收和解析来自网络的用户请求，然后根据请求完成预定义的任务。我们将这种二进制称为边界二进制(Redini et al, 2020)。通过这种方式，攻击者控制的数据被引入到固件中。后端可以假定所有接收到的数据在前端验证之后都是可信的。但是，攻击者可以绕过这种验证并直接发送恶意数据以使后端崩溃。最终，外部网络数据的滥用会导致安全漏洞。

为了调用边界二进制中的特定函数进行数据处理，前端向后端发送的请求包括一个action关键字和可能的多个参数关键字。action关键字用于触发不同的句柄函数，根据action关键字在边界二进制文件中注册一系列回调函数。参数关键字是用于标识请求中的数据字段值的键。这种数据传输模式也称为KEY-VALUE模型。前端和后端使用共享关键字描述相同的数据字段(Chen et al, 2021)。边界二进制使用key-value函数(Cheng et al .， 2021)(也称为input entry (Chen et al .， 2021))获取key - value模型的结构化数据，根据给定的键获取数据。

