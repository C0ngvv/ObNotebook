
2019 CCS

# 翻译
## 摘要
在这项工作中，我们提出了IoTHunter，这是第一个用于模糊物联网固件中有状态协议的灰盒模糊器。IoTHunter基于IoT固件运行时监控的多阶段消息生成机制解决状态调度问题。我们用一组现实世界的程序对IoTHunter进行了评估，结果表明IoTHunter优于黑盒模糊器boofuzz，后者在函数覆盖、块覆盖和边缘覆盖方面分别增加了2.2倍、2.0倍和2.5倍。IoTHunter还在家用路由器microtik的固件中发现了五个新的漏洞，这些漏洞已经报告给了供应商。

关键词：灰盒模糊测试；有状态协议模糊测试；物联网固件模糊测试

## 1.引言
如今，数十亿的IoT(物联网)设备连接到互联网，这些端点的安全漏洞可能会对隐私、储蓄、健康甚至生命造成风险。物联网固件使用大量有状态网络协议(如ssl、smb、ftp和bgp)来提供强大的功能，如设备管理、消息交换和自定义功能。然而，由于复杂的协议设计、交付时间限制和不安全的编码实践，物联网固件中脆弱的网络协议和服务应用容易留下前所未有的攻击面(例如臭名昭著的Mirai物联网僵尸网络)。因此，发现并修复物联网固件中的漏洞具有至关重要的意义。

最近的研究提出通过模糊测试来检测物联网固件中的漏洞。然而，模糊物联网固件必须克服三个挑战。(1)复杂的协议状态。物联网固件中的网络协议是有状态的，具有复杂的消息交互和状态转换。有状态协议的输入空间采用消息序列的形式。因此，为了模糊某一状态下的有状态协议，我们必须提前将目标系统设置为期望的状态。另外，在发送格式错误的消息时，会丢失协议状态。因此，大多数黑盒模糊测试工具(如boofuzz[2]和IoTFuzzer[4])无法有效覆盖状态轨迹，自动化程度较差。(2)不同协议的可扩展性。目前对物联网固件进行模糊测试的尝试仅限于某些协议，如http[8]、ssl[6]和vpn[5]。(3)测试用例验证。客户机和服务器之间的网络消息构造良好，必须检查接收到的每个消息的格式验证，例如消息长度、协议标识和校验和。目前模糊测试中的突变策略(例如，位翻转)是验证盲的，大多数突变的测试输入不能通过格式检查，在早期阶段被拒绝。因此，通过模糊物联网固件发现深层漏洞在很大程度上受到当前随机突变消息输入的限制[3][7][8]。


在这项工作中，我们介绍了IoTHunter，这是第一个(据我们所知)用于物联网固件中有状态协议的灰盒模糊器。在物联网固件的运行监控过程中，IoTHunter根据给定的状态序列依次切换到协议状态，进行基于反馈的状态探索，并通过多阶段消息生成进行覆盖引导的灰盒模糊测试。总之，我们做出了以下贡献。

- 为了使有状态网络协议在多个过程阶段完全模糊化，提出了一种多阶段消息生成技术。特别是，我们的方法可以充分模糊已知状态，并探索在给定状态序列中不存在的未知状态。
- 我们实现了一个名为IoTHunter的原型工具，它具有高覆盖率的有状态协议输入空间，高测试用例验证率，并支持物联网固件中的多个关键协议(例如snmp, ftp, ssl, bgp, smb)。
- 我们用一组现实世界的物联网程序对IoTHunter进行了评估，结果表明IoTHunter的性能优于黑盒模糊器boofuzz。我们还发现了五个新的漏洞，这些漏洞已经报告给了供应商

## 2.设计与实现
### 2.1 消息状态转换模型
考虑有状态协议P，状态集$S=<s_0, s_1, s_2,..., s_n >$，消息序列$M=\{{M_{i,j}, 0 <= i, j <= n}\}$，则状态转换关系可以用有向图G = (S, M)表示，其中$s_0$为服务请求的初始状态。在图G中，每个消息类型$M_{i,j}$表示可以从状态si迁移到状态sj的消息。特别是，如果j = 0，我们称Mi,0为无效消息(即格式错误)，这将导致系统失去当前状态si，并迁移到初始状态s0。图1显示了一个消息-状态转换模型，它表示由消息序列M驱动的状态转换关系。实线和虚线箭头分别表示有效和无效的消息类型。在有状态模糊测试过程中，测试用例是由模糊器生成的新消息。消息是否有效由物联网固件的运行时状态监控决定。因此，在本质上，状态模糊过程就是寻找输入空间的有效区域和无效区域之间的边界。

![](images/Pasted%20image%2020230803085823.png)

### 2.2 多状态消息生成
**输入**。如图2所示，输入空间由两部分组成:(1)描述协议规范中已知状态的状态序列S，以及每个状态中有效消息的种子集M;(2)消息格式要求，包括消息类型、长度字段、具体版本号、校验和字段等基本消息约束。

![](images/Pasted%20image%2020230803085948.png)

**工作流**。首先，我们使用特定于协议的解析器根据格式要求检查每条消息来提取元数据。然后，我们根据状态序列S调度协议状态，然后调用消息突变调度模块，基于消息种子生成新的测试用例。之后，我们根据消息格式需求检查测试用例，并在发生任何冲突时更新相应的字段。最后，我们将消息发送到IoT固件的运行目标，以收集执行跟踪和消息响应。

**协议状态调度进程**。考虑消息序列中的已知状态和未呈现的未知状态，协议状态调度过程由两部分组成:(1)**已知状态模糊**:从初始状态s0开始，根据消息种子直接生成新消息。然后，当出现任何违反格式要求的情况时，我们更新消息格式。将新消息发送到目标IoT固件后，如果新消息有效，则达到下一个状态s1，并收集有效消息M0,1。否则，将丢失当前状态并复位为s0。经过一段时间的模糊处理后，如果没有找到新的路径，我们将进入下一个状态。对于每一步状态si (i > 0)的模糊测试，我们首先需要检查当前状态，如果不是si-1，则附加消息Mi = M0,1 +M1,2 +…+Mi−2,i−1从有效消息集中选择，用于将当前状态调度到si-1。(2)**未知状态探索**：由于大多数现有的有状态协议都包含类型字段，因此我们使用整数突变策略来随机更改消息类型值，并将消息类型和打包到生成的消息中作为新的测试用例。然而，如果我们发现一个新的状态没有出现在状态序列S中，它将被添加到状态序列中。整个模糊处理完成后，得到一个有效的消息集M = M0,1 + M1,2 +…+ Mn−1，得到n，即有状态协议的整个输入空间。

**格式检查**。在模糊处理过程中，在发送之前根据协议格式要求检查每条消息。基于特定于协议的解析器，提取并存储每个消息的元数据。然后，检查元数据是否保留消息验证。例如，重新计算新消息的长度并将其写入长度字段。同时，消息类型必须与当前状态一致。

### 2.3 实现
IoTHunter是在AFL[1]、boofuzz[2]和Avatar2[7]之上实现的。IoTHunter包含两个核心模糊测试引擎，一个是调度协议状态的状态模糊器(在boofuzz之上实现)，另一个是智能地改变消息的消息模糊器(在AFL之上实现)。为了同时模糊协议状态和消息，IoTHunter按顺序调度其两个核心模糊器。特别是，为了保持AFL工作流程的完整性，同时允许AFL模糊物联网固件中的目标程序，我们用状态模糊器取代了用户模式。IoTHunter的其他组件包括一个基于Avatar2的固件模拟器、一个基于python的解析器和一个格式检查器。IoTHunter使用给定的固件映像初始化Avatar2目标，然后调用状态模糊器来调度协议状态，并通知消息模糊器执行随机突变。此外，在仿真器Avatar2中增加了一个带有新控制命令的监控模块来支持IoTHunter。IoTHunter的当前实现支持CPU架构，包括x86、x86-64。理论上，它也支持mips和arm。

## 3.评估
配置。我们使用来自家庭路由器microtik v6.38.4 x86和NAS Synology v15284 x86-64的八个真实IoT程序来评估IoTHunter。测试程序涵盖了处理网络请求的关键服务协议(如snmp、ftp、ssl、bgp、smb)，因此这些协议很容易成为远程攻击的目标。和其他的研究者一样\[6\]\[5\]，我们只模糊了每个协议握手过程中的状态。例如，ssl协议和smb协议的握手过程包括三种状态:s0、s1和s2。虽然snmp只有一种状态，但是模糊snmp遵循我们提出的工作流程。我们对每个协议状态进行了12小时的模糊处理(在单个核心上)，每个测试程序对每个12小时的实验重复5次，以减少模糊处理的随机性。我们在一台40核(2.8 GHz Intel Xeon E5- 2680 v2)、64GB内存、Ubuntu 16.04作为服务器操作系统的64位机器上进行了实验。我们的实验总时间超过30个CPU日。

发现。在测试过程中，我们从家用路由器microtik v6.38.4 x86中发现了五个新的漏洞(见表1)。当我们向供应商报告这些漏洞时，其他研究人员也发现了前三个漏洞，尽管我们提供的PoC与其他报告者不同(例如，CVE-2018-7445的请求ID 0x81)。

![](images/Pasted%20image%2020230803092516.png)

有状态的模糊测试。图3说明了有状态模糊处理过程。横轴表示模糊时间，纵轴表示探索的路径数。每行显示一个协议的模糊处理过程。我们可以看到，总路径在每个模糊状态开始时急剧增加，在每个模糊状态结束时保持稳定，这意味着每个协议被状态调度机制充分模糊。

![](images/Pasted%20image%2020230803092601.png)

比较。我们比较了IoTHunter和三种协议的黑匣子模糊器boofuzz[2]。比较从三个方面进行:函数覆盖、块覆盖和边缘覆盖。如图4所示，当对有状态协议进行模糊处理时，IoTHunter的性能优于boofuzz，后者在函数覆盖、块覆盖和边缘覆盖方面分别增加了2.2倍、2.0倍和2.5倍。我们还将IoTHunter与没有格式检查的版本进行比较。结果表明，IoTHunter中的格式检查机制在功能覆盖率、块覆盖率和边缘覆盖率方面分别平均提高1.7倍、1.4倍、1.6倍。结果表明，在对有状态网络协议进行模糊测试时，覆盖率引导的灰盒模糊测试优于黑盒模糊测试。

![](images/Pasted%20image%2020230803092805.png)

## 4.结论
在这篇文章中，我们提出了第一个灰盒模糊器IoTHunter，用于模糊物联网固件中的状态协议。在状态转换模型的基础上，提出了一种多阶段消息生成技术，实现了对有状态网络协议在多个过程阶段的充分模糊。实验表明，IoTHunter在功能覆盖、块覆盖和边缘覆盖方面优于黑盒模糊器boofuzz。我们还在microtik的固件中发现了五个新的漏洞，这些漏洞已经报告给了供应商。
