# SRFuzzer: An Automatic Fuzzing Framework for Physical SOHO Router Devices to Discover Multi-Type Vulnerabilities
![](images/Pasted%20image%2020231010083547.png)
2019 ACSAC

# 翻译
## 摘要
SOHO (small office/home office)路由器为终端设备接入Internet提供服务，在网络空间中扮演着重要的角色。不幸的是，这些路由器普遍存在安全漏洞，特别是在web服务器模块中，极大地危害了最终用户。为了发现这些漏洞，对SOHO路由器的web服务器模块进行模糊测试是最流行的解决方案。然而，由于缺乏输入规范、缺乏路由器内部运行状态、缺乏测试环境恢复机制等原因，其有效性受到限制。此外，模糊测试通常只报告内存损坏漏洞，而无法发现其他漏洞，例如基于web的漏洞。

在本文中，我们提出了一个解决方案SRFuzzer来解决这些问题。它是一个完全自动化的模糊测试框架，用于测试物理SOHO设备。它利用KEY-VALUE数据模型和CONF-READ通信模型两种输入语义模型，连续有效地生成测试用例，并通过电源管理自动恢复测试环境。它还协调多种突变规则和多种监控机制，触发多种类型的漏洞。据我们所知，这是SOHO路由器的第一个全流程全自动模糊测试框架。我们在5家厂商的10台流行路由器上运行了SRFuzzer。总共发现了208个独特的异常行为，其中97个已被确认为零日漏洞。实验结果表明，SRFuzzer在发现的漏洞类型和数量方面优于最先进的解决方案。

关键字：模糊测试，IoT，自动化漏洞检测，数据不一致

## 1.引言
越来越多的终端设备，如笔记本电脑、平板电脑、智能手机、智能家居设备和可穿戴设备，被用于社交生活。它们通常通过小型办公室和家庭办公室(SOHO)路由器连接到互联网。SOHO路由器将终端用户与外部互联网隔离开来[15]，处理终端用户的全部流量，处于突出地位。SOHO路由器的安全性比以往任何时候都更加重要。

不幸的是，SOHO路由器普遍存在安全漏洞[4]，[29]。根据最近的一份报告[6]，83%的流行路由器包含易受攻击的代码。这些漏洞是攻击者利用的主要目标之一。2018年，Cisco Talos发现针对Linksys、MikroTik、NETGEAR和TP-Link网络设备的恶意软件VPNFilter，这些设备都是SOHO路由器，在至少54个国家感染了至少50万台设备[5]。此外，领先的漏洞获取平台Zerodium[3]在2018年增加了对路由器的需求。因此，发现SOHO路由器的漏洞就显得尤为重要。

SOHO路由器的典型架构如图1的右侧所示。SOHO路由器作为网络设备，为接入它的终端设备提供路由等网络服务。更重要的是，由于缺乏用户界面(例如键盘、视频、鼠标)，它还利用web服务进行管理和配置。这些web服务由一些广泛使用的协议提供，例如超文本传输协议(HTTP)。本文将这些协议称为管理协议。

![](images/Pasted%20image%2020231010090004.png)

典型的管理协议是通过在原始设备中嵌入web服务器(后端)来实现的。通常，不同路由器中的web服务器是由设备供应商定制的，因此更容易受到攻击。最近的研究[12]，[15]，[11]表明，大多数被识别的SOHO路由器漏洞都与web服务有关，例如PHP服务器端脚本中的命令注入漏洞和处理移动应用程序web请求时的内存破坏漏洞。因此，本文也着重于发现SOHO路由器web服务器的漏洞

模糊测试(即模糊测试)被认为是一种发现漏洞的强大技术。然而，除了基于应用程序的模糊测试框架IoTFuzzer[11]外，对SOHO路由器web服务器的模糊测试(FWSR)研究很少。该方法借助可控制设备的移动APP程序逻辑，生成有意义的测试用例，触发设备bug。虽然它部分解决了FWSR的问题，但总的来说，FWSR仍然具有挑战性。

**挑战1:模糊专用系统**

SOHO路由器作为嵌入式设备，其功能是专用的，不容易扩展。因此，在测试过程中无法直接获取设备内部的运行状态，在测试过程中使设备卡住，也很难恢复其正常运行状态。这使得FWSR难以持续有效地进行。虽然基于仿真的模糊测试是一种很有前途的获取内部执行信息来指导模糊测试的方法，但它在全系统模式下对各种路由器的仿真受到限制。(见第6节)

**挑战2:分析输入语义**

web服务器的输入遵循标准协议，如超文本传输协议(HyperText Transfer Protocol, HTTP)，但其内部编码交换信息的数据在路由器之间格式各异。如果不调查内部数据和信息交换过程的格式，FWSR在代码覆盖方面是无效的。

**挑战3:发现多类型漏洞**

如上所述，web服务器几乎是由供应商从前端到后端定制的。因此，FWSR不仅应该发现web漏洞，如命令注入和跨站点脚本，还应该发现内存损坏。不幸的是，不同类型的漏洞需要由不同的有效载荷触发，并且需要通过不同的方法进行监控。这些要求使得FWSR的设计更加困难。

**我们的方法**

在本文中，我们提出了一个基于物理设备的FWSR自动模糊测试框架来解决上述挑战。通过自动生成种子和自动功率控制，连续驱动模糊过程。为了对输入语义建模，它利用两个模型来约束测试用例，即，KEY-VALUE数据模型(简称K-V模型)来描述请求的内部数据格式，以及CONF-READ通信模型(简称C-R模型)来描述请求的时间序列。此外，我们的框架协调了不同的突变规则和多种监控机制，有效触发了内存破坏、命令注入、跨站脚本攻击和信息泄露等四类漏洞。据我们所知，它是FWSR的第一个全流程全自动框架。此外，通过收集web请求和监控运行状态的一点人工努力，它可以胜过全自动模糊测试。

首先，为了自动生成种子，我们的框架采用基于爬虫的方法，从运行设备自动收集web请求头和请求内容[20]。同时，为了使设备从“僵尸”状态恢复，我们增加了一个基于Wi-Fi插头的电源控制模块，当设备卡住时强制重启。此外，我们的框架直接测试物理设备。设计决策是通用的和实用的，因为它不需要模拟固件，模拟固件对许多路由器来说是不可行的。

其次，我们的框架可以触发更深层次的bug，而无需固件逆向工程或插桩(反馈引导模糊技术[43]所需要的)。该框架利用K-V和C-R模型分别对数据格式和请求序列进行精确建模，从而对实际输入进行变异。通过K-V模型，我们能够区分值的数据类型，并分配不同的突变规则。通过C-R模型，我们可以构建多阶段通信，在一定的运行状态下触发bug。

第三，针对不同类型的漏洞，我们将其归纳为数据不一致漏洞。为了发现它们，我们将突变与监测结合起来。更具体地说，我们设计了六个突变规则和三个监测机制。当对给定类型的漏洞进行模糊测试时，我们选择适当的突变规则和监视机制。

我们已经实现了SRFuzzer解决方案的原型，并将其部署在现实环境中。为了评估其有效性和普遍性，我们在5家厂商的10台流行路由器上运行了SRFuzzer。得益于全面的新监控方法，我们获得了208个独特的异常行为。几乎一半的异常行为被确认为属于上述四种漏洞类型的101个独特问题。在向相应厂商负责地披露漏洞后，我们共获得了97个分配的ID，即43个CVE ID, 52个PSV ID和2个CNVD ID。

**贡献**。本文的贡献如下:

- 我们提出了一个全自动模糊测试框架来发现FWSR的各种漏洞。我们通过产生种子和自动恢复装置的方式来持续激励模糊测试。
- 我们设计了KEY-VALUE数据模型和CONF-READ通信模型，揭示了漏洞发生的根本原因，指导了漏洞的突变，并将6条突变规则与3种监控机制相协调，提高了漏洞发现的有效性。
- 我们实现了一个原型SRFuzzer，并在10个真实的SOHO路由器上对其进行了评估。总共在208个独特的异常行为中发现了101个已确认的问题，其中97个已被供应商确认为零日漏洞。结果表明，SRFuzzer在漏洞发现能力方面优于最先进的解决方案。

本文组织如下:第2节介绍了我们克服挑战的动机和见解。第3节概述了SRFuzzer并描述了详细的设计。第4节介绍了实验和评价。我们的框架和相关工作的缺点将在第5节和第6节中讨论。最后，我们在第七节进行总结。

## 2.动机
SRFuzzer的设计目标是为FWSR构建一个自动模糊测试框架，并尽可能多地发现漏洞。基于固件仿真构建框架是很简单的。然而，由于各种专用组件内置路由器的多样性，这种解决方案通常是非常困难的。我们认为，这将是一个通用的框架，自动模糊物理SOHO路由器直接，虽然它仍然具有挑战性。

在本节中，我们首先介绍我们关注的漏洞以及我们环境的假设。然后，我们总结了在对真实世界的路由器进行自动模糊测试时所面临的设计挑战。基于C-R和K-V模型分析了路由器漏洞的根本原因，并结合实例进行了分析。

### 2.1 范围和假设
除了网络服务外，为了管理和配置，还将web服务嵌入到SOHO路由器中。它们通常由标准协议提供，包括超文本传输协议(HTTP)、简单对象访问协议(SOAP)、通用即插即用协议(UPnP)等。这些协议由供应商实现，用于设置Wi-Fi密码、查找终端设备等。我们将这些协议称为管理协议，本文主要讨论HTTP协议。此外，我们假设SOHO路由器使用内置的WAN/LAN web服务，而不是移动到web服务[11]作为其默认设置。

SOHO路由器典型的管理协议实现由前端、后端和数据库三个主要部分组成。前端显示路由器的当前设置，并指导用户进行配置。后端解析从前端接收的请求并配置相关服务。数据库将当前配置存储在几个地方，例如NVRAM、数据库和配置文件。图2以CONF和READ操作的形式描述了这些部件的工作流程。

![](images/Pasted%20image%2020231010102830.png)

图2还显示了工作流中四种典型的漏洞类型。内存损坏和命令注入的漏洞通常发生在后端，而XSS通常发生在前端。前端和后端都可能出现信息泄露漏洞。不同类型的漏洞可以由不同的原因触发，例如，内存损坏通常是由于用户的输入处理不当而触发的。本文中的信息披露是指未经适当许可而访问具有特权的数据。另外两个漏洞是常见的web漏洞，大多数XSS问题都是存储在路由器中的XSS。

### 2.2 自动化整个模糊测试过程
实现FWSR自动化最重要的步骤是输入生成和运行恢复。



